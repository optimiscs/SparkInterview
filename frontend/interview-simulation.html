<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¨¡æ‹Ÿé¢è¯• - æ™ºèƒ½é¢è¯•è¯„åˆ†ç³»ç»Ÿ</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:'#2196F3',secondary:'#FF5722'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }
body {
font-family: "Noto Sans SC", "Roboto", sans-serif;
}
.code-editor {
font-family: "Consolas", "Monaco", "Courier New", monospace;
}
.code-editor:focus {
outline: none;
}
.volume-indicator {
width: 3px;
height: 15px;
background-color: #2196F3;
margin: 0 1px;
border-radius: 1px;
transition: height 0.1s ease;
}
.avatar-pulse {
animation: pulse 2s infinite;
}
@keyframes pulse {
0% {
box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4);
}
70% {
box-shadow: 0 0 0 10px rgba(33, 150, 243, 0);
}
100% {
box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
}
}
.network-indicator {
display: inline-block;
width: 8px;
height: 8px;
border-radius: 50%;
background-color: #4CAF50;
}
.custom-switch {
position: relative;
display: inline-block;
width: 44px;
height: 24px;
}
.custom-switch input {
opacity: 0;
width: 0;
height: 0;
}
.switch-slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: #e5e7eb;
transition: .4s;
border-radius: 24px;
}
.switch-slider:before {
position: absolute;
content: "";
height: 18px;
width: 18px;
left: 3px;
bottom: 3px;
background-color: white;
transition: .4s;
border-radius: 50%;
}
input:checked + .switch-slider {
background-color: #2196F3;
}
input:checked + .switch-slider:before {
transform: translateX(20px);
}
.progress-bar {
height: 4px;
background-color: #e5e7eb;
border-radius: 2px;
overflow: hidden;
}
.progress-value {
height: 100%;
background-color: #2196F3;
border-radius: 2px;
transition: width 0.3s ease;
}
</style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
    <a href="assessment-options.html" class="flex items-center">
      <img src="./static/logo.png" alt="logo" class="h-8 w-8 mr-2 inline-block align-middle">
      <p class="text-sm text-gray-600 ml-2">èŒé¢æ˜Ÿç«</p>
    </a>
    <nav class="flex space-x-8">
    <a href="../index.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
    <div class="w-5 h-5 flex items-center justify-center mr-2">
    <i class="ri-home-line"></i>
    </div>
    é¦–é¡µ
    </a>
    <a href="./setting_page1.html" class="flex items-center px-3 py-2 text-sm font-medium text-primary">
    <div class="w-5 h-5 flex items-center justify-center mr-2">
    <i class="ri-video-chat-line"></i>
    </div>
    é¢è¯•æ¨¡æ‹Ÿ
    </a>
    <a href="./assessment-options.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
    <div class="w-5 h-5 flex items-center justify-center mr-2">
    <i class="ri-bar-chart-line"></i>
    </div>
    èƒ½åŠ›è¯„ä¼°
    </a>
    <a href="./learning-resources.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
    <div class="w-5 h-5 flex items-center justify-center mr-2">
    <i class="ri-book-open-line"></i>
    </div>
    å­¦ä¹ èµ„æº
    </a>
    <a href="./user-profile.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
    <div class="w-5 h-5 flex items-center justify-center mr-2">
    <i class="ri-user-settings-line"></i>
    </div>
    ä¸ªäººä¸­å¿ƒ
    </a>
    </nav>
    <div class="flex items-center">
    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
    <i class="ri-user-line text-white"></i>
    </div>
    <div class="ml-2">
    <p class="text-sm font-medium text-gray-900">ææ˜å</p>
    <p class="text-xs text-gray-500">é«˜çº§ç”¨æˆ·</p>
    </div>
    </div>
    </div>
    </div>
    </div>
<!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
<main class="flex-1 flex overflow-hidden relative h-[calc(100vh-8.5rem)]">
<!-- å·¦ä¾§å†…å®¹åŒºåŸŸ -->
<div class="flex-1 flex flex-col p-6 transition-all duration-300 overflow-y-auto" id="main-content">
<button id="toggle-panel" class="absolute right-0 top-1/2 -translate-y-1/2 w-6 h-24 bg-white border border-gray-200 rounded-l-lg shadow-sm flex items-center justify-center hover:bg-gray-50 z-10">
<i class="ri-arrow-right-s-line text-gray-500" id="panel-arrow"></i>
</button>
<!-- é¢è¯•å®˜åŒºåŸŸ -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-6">
<div class="flex items-start">
<div class="w-16 h-16 rounded-full bg-primary bg-opacity-10 flex items-center justify-center avatar-pulse mr-4">
<i class="ri-user-line ri-xl text-primary"></i>
</div>
<div class="flex-1">
<div class="flex justify-between items-center mb-2">
<h3 class="text-lg font-medium text-gray-900">ææ•™æˆ (AIé¢è¯•å®˜)</h3>
<div class="flex items-center">
<div class="flex space-x-0.5 mr-2">
<div class="volume-indicator" style="height: 5px;"></div>
<div class="volume-indicator" style="height: 10px;"></div>
<div class="volume-indicator" style="height: 15px;"></div>
<div class="volume-indicator" style="height: 8px;"></div>
<div class="volume-indicator" style="height: 4px;"></div>
</div>
<span class="text-xs text-gray-500">æ­£åœ¨è¯´è¯</span>
</div>
</div>
<div class="bg-gray-50 p-4 rounded-lg">
<div class="flex justify-between items-start mb-2">
<span id="question-meta" class="text-xs text-gray-500">æ¬¢è¿æ¥åˆ°æ™ºèƒ½é¢è¯•ç³»ç»Ÿ</span>
<button id="question-settings-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
<i class="ri-settings-3-line"></i>
</button>
</div>
<p id="current-question" class="text-gray-800 leading-relaxed">æ‚¨å¥½ï¼æˆ‘æ˜¯ææ•™æˆï¼Œæ‚¨çš„AIé¢è¯•å®˜ã€‚æ¬¢è¿å‚åŠ æˆ‘ä»¬çš„æ™ºèƒ½é¢è¯•ç³»ç»Ÿï¼ğŸ‰

åœ¨å¼€å§‹æ­£å¼é¢è¯•ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆäº†è§£ä¸€ä¸‹æ‚¨çš„åŸºæœ¬æƒ…å†µã€‚è¯·æ‚¨ç”¨30ç§’æ—¶é—´ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±ï¼ŒåŒ…æ‹¬æ‚¨çš„æ•™è‚²èƒŒæ™¯ã€æŠ€æœ¯æ ˆä»¥åŠæ‚¨æœ€æ„Ÿå…´è¶£çš„æŠ€æœ¯é¢†åŸŸã€‚è¿™æ ·æˆ‘å°±èƒ½ä¸ºæ‚¨å‡†å¤‡æ›´åˆé€‚çš„é¢è¯•é¢˜ç›®ã€‚

è¯·ç¡®ä¿æ‚¨çš„æ‘„åƒå¤´å’Œéº¦å…‹é£å·²å¼€å¯ï¼Œæˆ‘ä¼šå®æ—¶åˆ†ææ‚¨çš„è¡¨æƒ…ã€è‚¢ä½“è¯­è¨€å’Œè¯­éŸ³æƒ…æ„Ÿï¼Œä¸ºæ‚¨æä¾›å…¨é¢çš„é¢è¯•åé¦ˆã€‚

å‡†å¤‡å¥½äº†å—ï¼Ÿè¯·å¼€å§‹æ‚¨çš„è‡ªæˆ‘ä»‹ç»ï¼</p>
</div>
</div>
</div>
</div>
<!-- ç”¨æˆ·æ‘„åƒå¤´åŒºåŸŸ -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-6 flex justify-center items-center" style="height:420px;">
  <div class="relative bg-gray-900 rounded-lg overflow-hidden flex justify-center items-center" style="width: 100%; height: 100%;">
    <video id="user-video" class="w-full h-full object-contain bg-black" style="max-width:100%;max-height:100%;" autoplay muted></video>
  </div>
<div class="absolute bottom-4 right-4 flex space-x-2">
<button class="w-10 h-10 bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full flex items-center justify-center text-white transition-colors">
<i class="ri-fullscreen-line"></i>
</button>
<button class="w-10 h-10 bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full flex items-center justify-center text-white transition-colors">
<i class="ri-camera-line"></i>
</button>
<button class="w-10 h-10 bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full flex items-center justify-center text-white transition-colors">
<i class="ri-mic-line"></i>
</button>
</div>
</div>
<!-- ç¼–ç¨‹é¢˜ç­”é¢˜åŒºåŸŸ -->
<div class="bg-white rounded-lg shadow-sm p-6 hidden" id="coding-area">
<h3 class="text-lg font-medium text-gray-900 mb-3">ç¼–ç¨‹é¢˜è§£ç­”</h3>
<div class="mb-3 flex space-x-2">
<button class="px-3 py-1 bg-primary text-white rounded-button whitespace-nowrap">Python</button>
<button class="px-3 py-1 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-button whitespace-nowrap">JavaScript</button>
<button class="px-3 py-1 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-button whitespace-nowrap">Java</button>
<button class="px-3 py-1 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-button whitespace-nowrap">C++</button>
</div>
<div class="bg-gray-900 rounded-lg p-4 text-white">
<pre class="code-editor" contenteditable="true" spellcheck="false">def backpropagation(network, X, y, learning_rate):
# å‰å‘ä¼ æ’­
output = forward_propagation(network, X)
# è®¡ç®—è¾“å‡ºå±‚çš„è¯¯å·®
output_error = y - output
output_delta = output_error * sigmoid_derivative(output)
# åå‘ä¼ æ’­è¯¯å·®
for layer in reversed(range(len(network) - 1)):
# è®¡ç®—å½“å‰å±‚çš„è¯¯å·®
current_layer = network[layer]
next_layer = network[layer + 1]
# è®¡ç®—å½“å‰å±‚çš„delta
current_delta = np.dot(next_layer['weights'].T, next_layer['delta']) * sigmoid_derivative(current_layer['output'])
# æ›´æ–°æƒé‡å’Œåç½®
current_layer['weights'] += learning_rate * np.outer(current_delta, current_layer['input'])
current_layer['bias'] += learning_rate * current_delta
return network</pre>
</div>
<div class="mt-3 flex justify-end">
<button class="bg-primary text-white px-4 py-2 rounded-button hover:bg-opacity-90 transition-colors whitespace-nowrap">
è¿è¡Œä»£ç 
</button>
</div>
</div>
</div>
<!-- å³ä¾§å®æ—¶æŒ‡æ ‡åŒºåŸŸ -->
<div class="w-[30%] bg-gray-50 p-6 border-l border-gray-200 overflow-y-auto transition-all duration-300" id="right-panel">
<!-- è¡¨æƒ…æ£€æµ‹ -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-6">
<div class="flex items-center justify-between mb-4">
<h3 class="font-medium text-gray-900">è¡¨æƒ…æ£€æµ‹</h3>
<div class="flex items-center">
<div class="w-2 h-2 bg-green-500 rounded-full mr-2 transition-colors duration-300"></div>
<span class="text-sm text-gray-500 transition-colors duration-300">å®æ—¶æ£€æµ‹ä¸­</span>
</div>
</div>
<div class="space-y-3">
<div>
<div class="flex justify-between items-center mb-1">
<span class="text-gray-700">å½“å‰è¡¨æƒ…</span>
<span class="text-primary font-medium">è‡ªç„¶</span>
</div>
<div class="h-2 bg-gray-100 rounded-full overflow-hidden">
<div class="h-full bg-primary" style="width: 85%"></div>
</div>
<div class="flex justify-between mt-1">
<span class="text-xs text-gray-500">ç½®ä¿¡åº¦</span>
<span class="text-xs text-gray-700">85%</span>
</div>
</div>
<div class="flex flex-wrap gap-2 mt-3">
<span class="px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700">å¾®ç¬‘ 12%</span>
<span class="px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700">ä¸“æ³¨ 8%</span>
<span class="px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700">æ€è€ƒ 5%</span>
</div>
</div>
</div>
<!-- åŠ¨ä½œæ£€æµ‹ -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-6">
<div class="flex items-center justify-between mb-4">
<h3 class="font-medium text-gray-900">åŠ¨ä½œæ£€æµ‹</h3>
<div class="flex items-center">
<div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
<span class="text-sm text-gray-500">å®æ—¶æ£€æµ‹ä¸­</span>
</div>
</div>
<div class="space-y-3">
<div>
<div class="flex justify-between items-center mb-1">
<span class="text-gray-700">å½“å‰å§¿æ€</span>
<span class="text-primary font-medium">æ­£å</span>
</div>
<div class="h-2 bg-gray-100 rounded-full overflow-hidden">
<div class="h-full bg-primary" style="width: 92%"></div>
</div>
<div class="flex justify-between mt-1">
<span class="text-xs text-gray-500">ç½®ä¿¡åº¦</span>
<span class="text-xs text-gray-700">92%</span>
</div>
</div>
<div class="flex flex-wrap gap-2 mt-3">
<span class="px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700">æ‰‹åŠ¿æ´»è·ƒåº¦ ä¸­ç­‰</span>
<span class="px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700">è§†çº¿äº¤äº’ è‰¯å¥½</span>
</div>
</div>
</div>
<!-- è¯­éŸ³æƒ…æ„Ÿåˆ†æ -->
<div class="bg-white rounded-lg shadow-sm p-6">
<div class="flex items-center justify-between mb-4">
<h3 class="font-medium text-gray-900">è¯­éŸ³æƒ…æ„Ÿåˆ†æ</h3>
<div class="flex items-center">
<div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
<span class="text-sm text-gray-500">å®æ—¶åˆ†æä¸­</span>
</div>
</div>
<div class="space-y-4">
<div>
<div class="flex justify-between items-center mb-1">
<span class="text-gray-700">å½“å‰æƒ…æ„Ÿ</span>
<span class="text-primary font-medium">è‡ªä¿¡</span>
</div>
<div class="h-2 bg-gray-100 rounded-full overflow-hidden">
<div class="h-full bg-primary" style="width: 88%"></div>
</div>
<div class="flex justify-between mt-1">
<span class="text-xs text-gray-500">ç½®ä¿¡åº¦</span>
<span class="text-xs text-gray-700">88%</span>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<div class="flex justify-between items-center mb-1">
<span class="text-sm text-gray-700">è¯­é€Ÿ</span>
<span class="text-sm text-primary">é€‚ä¸­</span>
</div>
<div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
<div class="h-full bg-primary" style="width: 75%"></div>
</div>
</div>
<div>
<div class="flex justify-between items-center mb-1">
<span class="text-sm text-gray-700">éŸ³è°ƒ</span>
<span class="text-sm text-primary">è‡ªç„¶</span>
</div>
<div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
<div class="h-full bg-primary" style="width: 82%"></div>
</div>
</div>
<div>
<div class="flex justify-between items-center mb-1">
<span class="text-sm text-gray-700">æ¸…æ™°åº¦</span>
<span class="text-sm text-primary">ä¼˜ç§€</span>
</div>
<div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
<div class="h-full bg-primary" style="width: 90%"></div>
</div>
</div>
</div>
<div class="mt-4">
<h4 class="text-sm font-medium text-gray-900 mb-2">å®æ—¶è¯­éŸ³è¯†åˆ«</h4>
<div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 h-20 overflow-y-auto">
åå‘ä¼ æ’­ç®—æ³•æ˜¯æ·±åº¦å­¦ä¹ ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç®—æ³•ï¼Œå®ƒé€šè¿‡è®¡ç®—æŸå¤±å‡½æ•°å¯¹å„å±‚å‚æ•°çš„æ¢¯åº¦æ¥æ›´æ–°ç½‘ç»œæƒé‡...
</div>
</div>
</div>
</div>
</div>
</main>
<!-- åº•éƒ¨æ§åˆ¶æ  -->
<footer class="bg-white border-t border-gray-200 py-4 px-6">
<div class="container mx-auto flex justify-between items-center">
<div class="flex items-center space-x-4">
<button class="bg-primary text-white px-4 py-2 rounded-button flex items-center hover:bg-opacity-90 transition-colors whitespace-nowrap">
<i class="ri-pause-line mr-1"></i>
<span>æš‚åœé¢è¯•</span>
</button>
<button id="next-question-btn" class="bg-blue-500 text-white px-4 py-2 rounded-button flex items-center hover:bg-opacity-90 transition-colors whitespace-nowrap">
<i class="ri-arrow-right-line mr-1"></i>
<span>ä¸‹ä¸€é“é¢˜</span>
</button>
<button class="bg-red-500 text-white px-4 py-2 rounded-button flex items-center hover:bg-opacity-90 transition-colors whitespace-nowrap">
<i class="ri-close-line mr-1"></i>
<span>ç»“æŸé¢è¯•</span>
</button>
</div>
<div class="flex items-center space-x-6">
<div class="flex items-center">
<span class="text-gray-700 mr-2">éº¦å…‹é£</span>
<label class="custom-switch">
<input type="checkbox" checked>
<span class="switch-slider"></span>
</label>
</div>
<div class="flex items-center">
<span class="text-gray-700 mr-2">æ‘„åƒå¤´</span>
<label class="custom-switch">
<input type="checkbox" checked>
<span class="switch-slider"></span>
</label>
</div>
<div class="flex items-center">
<span class="text-gray-700 mr-2">å…¨å±</span>
<label class="custom-switch">
<input type="checkbox">
<span class="switch-slider"></span>
</label>
</div>
<button id="settings-btn-footer" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-button flex items-center hover:bg-gray-200 transition-colors whitespace-nowrap">
<i class="ri-settings-line mr-1"></i>
<span>è®¾ç½®</span>
</button>
</div>
</div>
</footer>
<!-- ç»Ÿä¸€è®¾ç½®é¢æ¿æ ·å¼ -->
<style>
.custom-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.custom-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.switch-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.switch-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .switch-slider {
    background-color: #2196F3;
}

input:checked + .switch-slider:before {
    transform: translateX(26px);
}

.settings-tab.active {
color: #2196F3;
border-color: #2196F3;
}

.config-section {
transition: all 0.3s ease;
}

.config-section:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
</style>

<script id="camera-script">
document.addEventListener('DOMContentLoaded', function() {
const userVideo = document.getElementById('user-video');
    
    // æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤º
    const videoContainer = userVideo.parentElement;
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 text-white';
    loadingIndicator.innerHTML = '<div class="text-center"><i class="ri-loader-4-line animate-spin text-2xl mb-2"></i><div>æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´...</div></div>';
    videoContainer.appendChild(loadingIndicator);
    
    // å…¨å±€éŸ³é¢‘æµå˜é‡
    let audioStream = null;
    let microphonePermissionGranted = false;
    
    // å°è¯•è·å–åª’ä½“æµ
    async function initializeCamera() {
        try {
            // é¦–å…ˆå°è¯•åªè·å–è§†é¢‘
            const videoStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                }, 
                audio: false 
            });
            
            userVideo.srcObject = videoStream;
            loadingIndicator.remove();
            console.log('âœ… æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸ');
            
            // å°è¯•è·å–éŸ³é¢‘æƒé™ï¼ˆä½†ä¸ç«‹å³ä½¿ç”¨ï¼‰
            await requestMicrophonePermission();
            
        } catch (err) {
            console.error('âŒ æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', err);
            loadingIndicator.innerHTML = `
                <div class="text-center">
                    <i class="ri-error-warning-line text-2xl mb-2 text-red-400"></i>
                    <div class="mb-2">æ‘„åƒå¤´è®¿é—®å¤±è´¥</div>
                    <div class="text-sm text-gray-300 mb-3">${err.message}</div>
                    <button onclick="location.reload()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                        é‡æ–°åŠ è½½
                    </button>
                </div>
            `;
        }
    }
    
    // è¯·æ±‚éº¦å…‹é£æƒé™
    async function requestMicrophonePermission() {
        try {
            // æ£€æŸ¥éº¦å…‹é£æƒé™çŠ¶æ€
            const permission = await navigator.permissions.query({ name: 'microphone' });
            
            if (permission.state === 'granted') {
                console.log('âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ');
                microphonePermissionGranted = true;
                return true;
            } else if (permission.state === 'denied') {
                console.warn('âš ï¸ éº¦å…‹é£æƒé™è¢«æ‹’ç»');
                showMicrophonePermissionDialog();
                return false;
            } else {
                // å°è¯•è·å–éº¦å…‹é£æƒé™
                console.log('ğŸ”„ è¯·æ±‚éº¦å…‹é£æƒé™...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: false, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });
                
                // ç«‹å³åœæ­¢æµï¼Œåªè·å–æƒé™
                stream.getTracks().forEach(track => track.stop());
                
                console.log('âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                microphonePermissionGranted = true;
                return true;
            }
        } catch (audioErr) {
            console.warn('âš ï¸ éº¦å…‹é£æƒé™è·å–å¤±è´¥:', audioErr);
            
            if (audioErr.name === 'NotAllowedError') {
                showMicrophonePermissionDialog();
            } else if (audioErr.name === 'NotFoundError') {
                showMicrophoneNotFoundDialog();
            } else if (audioErr.name === 'NotReadableError') {
                showMicrophoneInUseDialog();
            } else {
                showMicrophoneErrorDialog(audioErr.message);
            }
            
            return false;
        }
    }
    
    // æ˜¾ç¤ºéº¦å…‹é£æƒé™å¯¹è¯æ¡†
    function showMicrophonePermissionDialog() {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        dialog.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                <div class="text-center">
                    <i class="ri-mic-off-line text-4xl text-orange-500 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">éº¦å…‹é£æƒé™è¢«æ‹’ç»</h3>
                    <p class="text-gray-600 mb-4">è¯­éŸ³åˆ†æåŠŸèƒ½éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
                    <div class="bg-gray-50 p-3 rounded text-sm text-gray-700 mb-4">
                        <p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p>
                        <ol class="list-decimal list-inside space-y-1 mt-2">
                            <li>ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å®šå›¾æ ‡</li>
                            <li>å°†éº¦å…‹é£æƒé™è®¾ç½®ä¸º"å…è®¸"</li>
                            <li>åˆ·æ–°é¡µé¢é‡æ–°å°è¯•</li>
                        </ol>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            ç¨åå¤„ç†
                        </button>
                        <button onclick="location.reload()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            åˆ·æ–°é¡µé¢
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
    }
    
    // æ˜¾ç¤ºéº¦å…‹é£æœªæ‰¾åˆ°å¯¹è¯æ¡†
    function showMicrophoneNotFoundDialog() {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        dialog.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                <div class="text-center">
                    <i class="ri-mic-off-line text-4xl text-red-500 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">æœªæ£€æµ‹åˆ°éº¦å…‹é£</h3>
                    <p class="text-gray-600 mb-4">ç³»ç»Ÿæœªæ‰¾åˆ°å¯ç”¨çš„éº¦å…‹é£è®¾å¤‡ã€‚</p>
                    <div class="bg-gray-50 p-3 rounded text-sm text-gray-700 mb-4">
                        <p><strong>æ£€æŸ¥é¡¹ç›®ï¼š</strong></p>
                        <ul class="list-disc list-inside space-y-1 mt-2">
                            <li>ç¡®è®¤éº¦å…‹é£å·²æ­£ç¡®è¿æ¥</li>
                            <li>æ£€æŸ¥ç³»ç»ŸéŸ³é¢‘è®¾ç½®</li>
                            <li>å°è¯•ä½¿ç”¨å¤–æ¥éº¦å…‹é£</li>
                        </ul>
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        çŸ¥é“äº†
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
    }
    
    // æ˜¾ç¤ºéº¦å…‹é£è¢«å ç”¨å¯¹è¯æ¡†
    function showMicrophoneInUseDialog() {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        dialog.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                <div class="text-center">
                    <i class="ri-mic-off-line text-4xl text-orange-500 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">éº¦å…‹é£è¢«å ç”¨</h3>
                    <p class="text-gray-600 mb-4">éº¦å…‹é£æ­£åœ¨è¢«å…¶ä»–åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚</p>
                    <div class="bg-gray-50 p-3 rounded text-sm text-gray-700 mb-4">
                        <p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p>
                        <ul class="list-disc list-inside space-y-1 mt-2">
                            <li>å…³é—­å…¶ä»–ä½¿ç”¨éº¦å…‹é£çš„åº”ç”¨</li>
                            <li>æ£€æŸ¥ç³»ç»ŸéŸ³é¢‘è®¾ç½®</li>
                            <li>é‡å¯æµè§ˆå™¨</li>
                        </ul>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            ç¨åå¤„ç†
                        </button>
                        <button onclick="location.reload()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            é‡è¯•
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
    }
    
    // æ˜¾ç¤ºéº¦å…‹é£é”™è¯¯å¯¹è¯æ¡†
    function showMicrophoneErrorDialog(errorMessage) {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        dialog.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                <div class="text-center">
                    <i class="ri-error-warning-line text-4xl text-red-500 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">éº¦å…‹é£åˆå§‹åŒ–å¤±è´¥</h3>
                    <p class="text-gray-600 mb-4">${errorMessage}</p>
                    <div class="bg-gray-50 p-3 rounded text-sm text-gray-700 mb-4">
                        <p><strong>å»ºè®®æ“ä½œï¼š</strong></p>
                        <ul class="list-disc list-inside space-y-1 mt-2">
                            <li>æ£€æŸ¥éº¦å…‹é£ç¡¬ä»¶è¿æ¥</li>
                            <li>æ›´æ–°éŸ³é¢‘é©±åŠ¨ç¨‹åº</li>
                            <li>å°è¯•ä½¿ç”¨ä¸åŒçš„æµè§ˆå™¨</li>
                        </ul>
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        çŸ¥é“äº†
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
    }
    
    // è·å–éº¦å…‹é£æµï¼ˆç”¨äºè¯­éŸ³åˆ†æï¼‰
    async function getMicrophoneStream() {
        if (!microphonePermissionGranted) {
            const granted = await requestMicrophonePermission();
            if (!granted) {
                return null;
            }
        }
        
        try {
            audioStream = await navigator.mediaDevices.getUserMedia({ 
                video: false, 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 16000
                }
            });
            console.log('âœ… éº¦å…‹é£æµè·å–æˆåŠŸ');
            return audioStream;
        } catch (error) {
            console.error('âŒ è·å–éº¦å…‹é£æµå¤±è´¥:', error);
            return null;
        }
    }
    
    // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        loadingIndicator.innerHTML = `
            <div class="text-center">
                <i class="ri-error-warning-line text-2xl mb-2 text-red-400"></i>
                <div>æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®</div>
                <div class="text-sm text-gray-300 mt-2">è¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Safariæœ€æ–°ç‰ˆæœ¬</div>
            </div>
        `;
        return;
    }
    
    // åˆå§‹åŒ–æ‘„åƒå¤´
    initializeCamera();
});
</script>



</script>


<!-- Flask API é›†æˆè„šæœ¬ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script id="flask-api-integration">
document.addEventListener('DOMContentLoaded', function() {
    // APIé…ç½®
    const API_BASE_URL = 'http://localhost:5001';
    const SOCKET_URL = 'http://localhost:5001';
    
    // å…¨å±€çŠ¶æ€
    let socket = null;
    let isAnalysisRunning = false;
    let isVoiceAnalysisRunning = false;
    let sessionId = null;
    let analysisStartTime = null;
    
    // è·å–DOMå…ƒç´  - æ”¹è¿›é€‰æ‹©å™¨
    function getDOMElements() {
        // ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
        const rightPanel = document.getElementById('right-panel');
        if (!rightPanel) {
            console.error('âŒ å³ä¾§é¢æ¿æœªæ‰¾åˆ°');
            return { expressionCard: null, motionCard: null, voiceCard: null };
        }
        
        // è·å–æ‰€æœ‰å¡ç‰‡
        const cards = rightPanel.querySelectorAll('.bg-white.rounded-lg.shadow-sm.p-6');
        console.log('ğŸ” æ‰¾åˆ°å¡ç‰‡æ•°é‡:', cards.length);
        
        let expressionCard = null;
        let motionCard = null;
        let voiceCard = null;
        
        cards.forEach((card, index) => {
            const cardText = card.textContent || '';
            console.log(`å¡ç‰‡ ${index + 1}:`, cardText.substring(0, 50));
            
            if (cardText.includes('è¡¨æƒ…æ£€æµ‹') || cardText.includes('å¾®è¡¨æƒ…')) {
                expressionCard = card;
                console.log('âœ… æ‰¾åˆ°è¡¨æƒ…æ£€æµ‹å¡ç‰‡');
            } else if (cardText.includes('åŠ¨ä½œæ£€æµ‹') || cardText.includes('è‚¢ä½“åŠ¨ä½œ')) {
                motionCard = card;
                console.log('âœ… æ‰¾åˆ°åŠ¨ä½œæ£€æµ‹å¡ç‰‡');
            } else if (cardText.includes('è¯­éŸ³æƒ…æ„Ÿ') || cardText.includes('è¯­éŸ³åˆ†æ')) {
                voiceCard = card;
                console.log('âœ… æ‰¾åˆ°è¯­éŸ³æƒ…æ„Ÿåˆ†æå¡ç‰‡');
            }
        });
        
        // å¦‚æœé€šè¿‡æ–‡æœ¬æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ä½ç½®é€‰æ‹©å™¨
        if (!expressionCard && cards.length >= 1) {
            expressionCard = cards[0];
            console.log('âš ï¸ ä½¿ç”¨ä½ç½®é€‰æ‹©å™¨æ‰¾åˆ°è¡¨æƒ…å¡ç‰‡');
        }
        if (!motionCard && cards.length >= 2) {
            motionCard = cards[1];
            console.log('âš ï¸ ä½¿ç”¨ä½ç½®é€‰æ‹©å™¨æ‰¾åˆ°åŠ¨ä½œå¡ç‰‡');
        }
        if (!voiceCard && cards.length >= 3) {
            voiceCard = cards[2];
            console.log('âš ï¸ ä½¿ç”¨ä½ç½®é€‰æ‹©å™¨æ‰¾åˆ°è¯­éŸ³å¡ç‰‡');
        }
        
        console.log('ğŸ” DOMå…ƒç´ æŸ¥æ‰¾ç»“æœ:');
        console.log('  è¡¨æƒ…å¡ç‰‡:', expressionCard);
        console.log('  åŠ¨ä½œå¡ç‰‡:', motionCard);
        console.log('  è¯­éŸ³å¡ç‰‡:', voiceCard);
        
        return { expressionCard, motionCard, voiceCard };
    }
    
    // å…¨å±€å˜é‡ï¼Œåœ¨åˆå§‹åŒ–æ—¶è®¾ç½®
    let expressionCard = null;
    let motionCard = null;
    let voiceCard = null;
    

    
    // åˆå§‹åŒ–é¢æ¿æ§åˆ¶
    function initPanelControl() {
        const mainContent = document.getElementById('main-content');
        const rightPanel = document.getElementById('right-panel');
        const toggleButton = document.getElementById('toggle-panel');
        const panelArrow = document.getElementById('panel-arrow');
        
        if (mainContent && rightPanel && toggleButton && panelArrow) {
            let isPanelVisible = true;
            
            function togglePanel() {
                isPanelVisible = !isPanelVisible;
                if (isPanelVisible) {
                    rightPanel.style.width = '30%';
                    rightPanel.style.opacity = '1';
                    mainContent.style.paddingRight = '24px';
                    panelArrow.classList.remove('ri-arrow-left-s-line');
                    panelArrow.classList.add('ri-arrow-right-s-line');
                } else {
                    rightPanel.style.width = '0';
                    rightPanel.style.opacity = '0';
                    mainContent.style.paddingRight = '48px';
                    panelArrow.classList.remove('ri-arrow-right-s-line');
                    panelArrow.classList.add('ri-arrow-left-s-line');
                }
            }
            
            toggleButton.addEventListener('click', togglePanel);
            console.log('âœ… é¢æ¿æ§åˆ¶å·²åˆå§‹åŒ–');
    } else {
            console.warn('âš ï¸ é¢æ¿æ§åˆ¶å…ƒç´ æœªæ‰¾åˆ°');
        }
    }
    
    // åˆå§‹åŒ–è®¾ç½®é¢æ¿
    function initSettingsPanel() {
        // è®¾ç½®é¢æ¿åŠŸèƒ½å·²åœ¨ç»Ÿä¸€è®¾ç½®é¢æ¿ä¸­å®ç°
        console.log('âœ… è®¾ç½®é¢æ¿å·²åˆå§‹åŒ–ï¼ˆç»Ÿä¸€è®¾ç½®é¢æ¿ï¼‰');
    }
    
    // åˆå§‹åŒ–éŸ³é¢‘å¯è§†åŒ–
    function initAudioVisualization() {
        const volumeIndicators = document.querySelectorAll('.volume-indicator');
        if (volumeIndicators.length > 0) {
            function animateVolumeIndicators() {
                volumeIndicators.forEach(indicator => {
                    const randomHeight = Math.floor(Math.random() * 15) + 3;
                    indicator.style.height = `${randomHeight}px`;
                });
            }
            setInterval(animateVolumeIndicators, 200);
            console.log('âœ… éŸ³é¢‘å¯è§†åŒ–å·²åˆå§‹åŒ–');
} else {
            console.warn('âš ï¸ éŸ³é¢‘å¯è§†åŒ–å…ƒç´ æœªæ‰¾åˆ°');
        }
    }
    
    // åˆå§‹åŒ–WebSocketè¿æ¥
    function initSocket() {
        try {
            socket = io(SOCKET_URL, {
                transports: ['websocket', 'polling'],
                timeout: 10000,
                reconnection: true,
                reconnectionAttempts: 10,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                maxReconnectionAttempts: 10
            });
            
            socket.on('connect', () => {
                console.log('âœ… WebSocketå·²è¿æ¥');
                updateConnectionStatus(true);
                
                // è¿æ¥æˆåŠŸåï¼Œç¡®ä¿åˆ†ææ­£åœ¨è¿è¡Œ
                if (!isAnalysisRunning) {
                    console.log('ğŸ”„ WebSocketè¿æ¥æˆåŠŸï¼Œæ£€æŸ¥åˆ†æçŠ¶æ€...');
                    getAnalysisStatus().then(result => {
                        if (result && !result.is_running) {
                            startAnalysis();
                            startVoiceAnalysis();
                        }
                    });
                }
            });
            
            socket.on('disconnect', (reason) => {
                console.log('âŒ WebSocketè¿æ¥æ–­å¼€:', reason);
                updateConnectionStatus(false);
                
                // æ–­å¼€æ—¶ä½¿ç”¨HTTPè½®è¯¢
                if (reason === 'io server disconnect') {
                    console.log('ğŸ”„ æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€ï¼Œä½¿ç”¨HTTPè½®è¯¢...');
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('WebSocketè¿æ¥é”™è¯¯:', error);
                updateConnectionStatus(false);
            });
            
            socket.on('connect_timeout', () => {
                console.error('WebSocketè¿æ¥è¶…æ—¶');
                updateConnectionStatus(false);
            });
            
            socket.on('reconnect', (attemptNumber) => {
                console.log(`ğŸ”„ WebSocketé‡è¿æˆåŠŸ (ç¬¬${attemptNumber}æ¬¡)`);
                updateConnectionStatus(true);
            });
            
            socket.on('reconnect_attempt', (attemptNumber) => {
                console.log(`ğŸ”„ WebSocketé‡è¿å°è¯• (ç¬¬${attemptNumber}æ¬¡)`);
            });
            
            socket.on('reconnect_error', (error) => {
                console.error('WebSocketé‡è¿å¤±è´¥:', error);
            });
            
            socket.on('reconnect_failed', () => {
                console.error('WebSocketé‡è¿å¤±è´¥ï¼Œåˆ‡æ¢åˆ°HTTPè½®è¯¢æ¨¡å¼');
                updateConnectionStatus(false);
            });
            
            socket.on('detection_result', (data) => {
                console.log('ğŸ“¡ æ”¶åˆ°æ£€æµ‹ç»“æœ:', data);
                updateExpressionData(data);
                updateMotionData(data);
            });
            
            socket.on('voice_analysis_result', (data) => {
                console.log('ğŸ“¡ æ”¶åˆ°è¯­éŸ³åˆ†æç»“æœ:', data);
                updateVoiceData(data);
            });
            
            socket.on('status', (data) => {
                console.log('æœåŠ¡å™¨çŠ¶æ€:', data.message);
            });
            
        } catch (error) {
            console.error('WebSocketè¿æ¥å¤±è´¥:', error);
            updateConnectionStatus(false);
        }
    }
    
    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(connected) {
        const networkIndicator = document.querySelector('.network-indicator');
        const networkStatus = document.getElementById('network-status');
        
        if (networkIndicator && networkStatus) {
            if (connected) {
                networkIndicator.style.backgroundColor = '#4CAF50';
                networkStatus.textContent = 'å·²è¿æ¥';
            } else {
                networkIndicator.style.backgroundColor = '#f44336';
                networkStatus.textContent = 'æœªè¿æ¥';
            }
        }
    }
    
    // æ›´æ–°åˆ†æçŠ¶æ€
    function updateAnalysisStatus(running) {
        const statusDots = document.querySelectorAll('.w-2.h-2.bg-green-500');
        const statusTexts = document.querySelectorAll('.text-sm.text-gray-500');
        const analysisStatusDot = document.getElementById('analysis-status-dot');
        const analysisStatusText = document.getElementById('analysis-status-text');
        const startAnalysisBtn = document.getElementById('start-analysis-btn');
        
        // æ›´æ–°æ‰€æœ‰çŠ¶æ€æŒ‡ç¤ºå™¨
        statusDots.forEach(dot => {
            dot.style.backgroundColor = running ? '#4CAF50' : '#9CA3AF';
        });
        
        statusTexts.forEach(text => {
            if (text.textContent.includes('æ£€æµ‹ä¸­') || text.textContent.includes('åˆ†æä¸­')) {
                text.textContent = running ? 'å®æ—¶æ£€æµ‹ä¸­' : 'å·²åœæ­¢';
            }
        });
        
        // æ›´æ–°é¡¶éƒ¨åˆ†æçŠ¶æ€
        if (analysisStatusDot && analysisStatusText) {
            if (running) {
                analysisStatusDot.style.backgroundColor = '#4CAF50';
                analysisStatusText.textContent = 'è¿è¡Œä¸­';
            } else {
                analysisStatusDot.style.backgroundColor = '#9CA3AF';
                analysisStatusText.textContent = 'å·²åœæ­¢';
            }
        }
        
        // æ›´æ–°å¯åŠ¨æŒ‰é’®
        if (startAnalysisBtn) {
            if (running) {
                startAnalysisBtn.className = 'bg-yellow-100 text-yellow-600 px-3 py-1.5 rounded-button flex items-center hover:bg-yellow-200 transition-colors whitespace-nowrap';
                startAnalysisBtn.innerHTML = '<i class="ri-pause-line mr-1"></i><span>åœæ­¢åˆ†æ</span>';
            } else {
                startAnalysisBtn.className = 'bg-green-100 text-green-600 px-3 py-1.5 rounded-button flex items-center hover:bg-green-200 transition-colors whitespace-nowrap';
                startAnalysisBtn.innerHTML = '<i class="ri-play-line mr-1"></i><span>å¯åŠ¨åˆ†æ</span>';
            }
        }
    }
    
    // å¯åŠ¨åˆ†æ
    async function startAnalysis() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/analysis/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                body: JSON.stringify({
                    camera_id: 0
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'success') {
                isAnalysisRunning = true;
                sessionId = result.session_id;
                analysisStartTime = Date.now();
                console.log('âœ… åˆ†æå·²å¯åŠ¨:', result.session_id);
                
                // æ›´æ–°UIçŠ¶æ€
                updateAnalysisStatus(true);
                
                // å¯åŠ¨è¯­éŸ³åˆ†æ
                startVoiceAnalysis();
                
                return true;
            } else {
                console.error('âŒ å¯åŠ¨åˆ†æå¤±è´¥:', result.message);
                return false;
            }
            
        } catch (error) {
            console.error('âŒ å¯åŠ¨åˆ†æè¯·æ±‚å¤±è´¥:', error);
            return false;
        }
    }
    
    // åœæ­¢åˆ†æ
    async function stopAnalysis() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/analysis/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'success') {
                isAnalysisRunning = false;
                sessionId = null;
                analysisStartTime = null;
                console.log('âœ… åˆ†æå·²åœæ­¢');
                
                // æ›´æ–°UIçŠ¶æ€
                updateAnalysisStatus(false);
                
                // åœæ­¢è¯­éŸ³åˆ†æ
                stopVoiceAnalysis();
                
                return true;
            } else {
                console.error('âŒ åœæ­¢åˆ†æå¤±è´¥:', result.message);
                return false;
            }
            
        } catch (error) {
            console.error('âŒ åœæ­¢åˆ†æè¯·æ±‚å¤±è´¥:', error);
            return false;
        }
    }
    
    // å¯åŠ¨è¯­éŸ³åˆ†æ
    async function startVoiceAnalysis() {
        try {
            console.log('ğŸ”„ å°è¯•å¯åŠ¨è¯­éŸ³åˆ†æ...');
            
            const response = await fetch(`${API_BASE_URL}/api/v1/voice/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors'
            });
            
            const result = await response.json();
            console.log('ğŸ“¡ è¯­éŸ³åˆ†æå¯åŠ¨å“åº”:', result);
            
            if (response.ok && result.status === 'success') {
                isVoiceAnalysisRunning = true;
                console.log('âœ… è¯­éŸ³åˆ†æå·²å¯åŠ¨');
                return true;
            } else {
                console.error('âŒ å¯åŠ¨è¯­éŸ³åˆ†æå¤±è´¥:', result.message);
                // å¦‚æœæ˜¯è¯­éŸ³åˆ†æå™¨æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
                if (result.message && result.message.includes('æœªåˆå§‹åŒ–')) {
                    console.log('ğŸ”„ è¯­éŸ³åˆ†æå™¨æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–...');
                    await initializeVoiceAnalyzer();
                    // é‡è¯•å¯åŠ¨
                    return await startVoiceAnalysis();
                }
                return false;
            }
            
        } catch (error) {
            console.error('âŒ å¯åŠ¨è¯­éŸ³åˆ†æè¯·æ±‚å¤±è´¥:', error);
            return false;
        }
    }
    
    // åˆå§‹åŒ–è¯­éŸ³åˆ†æå™¨
    async function initializeVoiceAnalyzer() {
        try {
            console.log('ğŸ”„ åˆå§‹åŒ–è¯­éŸ³åˆ†æå™¨...');
            
            // æ£€æŸ¥è¯­éŸ³åˆ†æå™¨çŠ¶æ€
            const statusResponse = await fetch(`${API_BASE_URL}/api/v1/voice/status`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors'
            });
            
            const statusResult = await statusResponse.json();
            console.log('ğŸ“¡ è¯­éŸ³åˆ†æå™¨çŠ¶æ€:', statusResult);
            
            if (!statusResult.is_available) {
                console.warn('âš ï¸ è¯­éŸ³åˆ†æå™¨ä¸å¯ç”¨ï¼Œè·³è¿‡è¯­éŸ³åˆ†æåŠŸèƒ½');
                return false;
            }
            
            return true;
            
        } catch (error) {
            console.error('âŒ åˆå§‹åŒ–è¯­éŸ³åˆ†æå™¨å¤±è´¥:', error);
            return false;
        }
    }
    
    // åœæ­¢è¯­éŸ³åˆ†æ
    async function stopVoiceAnalysis() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/voice/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'success') {
                isVoiceAnalysisRunning = false;
                console.log('âœ… è¯­éŸ³åˆ†æå·²åœæ­¢');
                return true;
            } else {
                console.error('âŒ åœæ­¢è¯­éŸ³åˆ†æå¤±è´¥:', result.message);
                return false;
            }
            
        } catch (error) {
            console.error('âŒ åœæ­¢è¯­éŸ³åˆ†æè¯·æ±‚å¤±è´¥:', error);
            return false;
        }
    }
    
    // æ›´æ–°åˆ†æçŠ¶æ€UI
    function updateAnalysisStatus(running) {
        const statusDots = document.querySelectorAll('.w-2.h-2.bg-green-500');
        const statusTexts = document.querySelectorAll('.text-sm.text-gray-500');
        
        statusDots.forEach(dot => {
            dot.style.backgroundColor = running ? '#4CAF50' : '#9CA3AF';
        });
        
        statusTexts.forEach(text => {
            if (text.textContent.includes('æ£€æµ‹ä¸­') || text.textContent.includes('åˆ†æä¸­')) {
                text.textContent = running ? 'å®æ—¶æ£€æµ‹ä¸­' : 'å·²åœæ­¢';
            }
        });
    }
    
    // æ›´æ–°è¡¨æƒ…æ£€æµ‹æ•°æ®
    function updateExpressionData(data) {
        console.log('ğŸ” å¼€å§‹æ›´æ–°è¡¨æƒ…æ•°æ®:', data);
        console.log('ğŸ” è¡¨æƒ…å¡ç‰‡å…ƒç´ :', expressionCard);
        
        if (!expressionCard) {
            console.error('âŒ è¡¨æƒ…å¡ç‰‡å…ƒç´ æœªæ‰¾åˆ°');
            // å°è¯•é‡æ–°è·å–DOMå…ƒç´ 
            const elements = getDOMElements();
            expressionCard = elements.expressionCard;
            if (!expressionCard) {
                console.error('âŒ é‡æ–°è·å–è¡¨æƒ…å¡ç‰‡å¤±è´¥');
            return;
            }
        }
        
        // å¤„ç†ç©ºæ•°æ®æˆ–æ— æ•ˆæ•°æ®
        if (!data || !data.expression) {
            console.warn('âš ï¸ è¡¨æƒ…æ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤å€¼');
            const expressionText = expressionCard.querySelector('.text-primary.font-medium');
            const confidenceBar = expressionCard.querySelector('.h-2.bg-gray-100 .bg-primary');
            const confidenceText = expressionCard.querySelector('.text-xs.text-gray-700');
            
            if (expressionText) {
                expressionText.textContent = 'è‡ªç„¶';
            }
            if (confidenceBar) {
                confidenceBar.style.width = '75%';
            }
            if (confidenceText) {
                confidenceText.textContent = '75%';
            }
            return;
        }
        
        console.log('ğŸ“Š æ›´æ–°è¡¨æƒ…æ•°æ®:', data.expression);
        
        const expressionText = expressionCard.querySelector('.text-primary.font-medium');
        const confidenceBar = expressionCard.querySelector('.h-2.bg-gray-100 .bg-primary');
        const confidenceText = expressionCard.querySelector('.text-xs.text-gray-700');
        
        if (expressionText) {
            expressionText.textContent = data.expression.name || 'è‡ªç„¶';
        }
        
        if (confidenceBar) {
            const confidence = Math.min(Math.round(data.expression.confidence * 100), 100);
            confidenceBar.style.width = `${confidence}%`;
        }
        
        if (confidenceText) {
            const confidence = Math.min(Math.round(data.expression.confidence * 100), 100);
            confidenceText.textContent = `${confidence}%`;
        }
        
        // æ›´æ–°åŠ¨ä½œå•å…ƒæ ‡ç­¾ - æ˜¾ç¤ºæ‰€æœ‰åŠ¨ä½œå•å…ƒï¼Œå³ä½¿å€¼ä¸º0
        const tagsContainer = expressionCard.querySelector('.flex.flex-wrap.gap-2');
        if (tagsContainer) {
            // è·å–æ‰€æœ‰å¯èƒ½çš„åŠ¨ä½œå•å…ƒ
            const allActionUnits = [
                'AU1', 'AU2', 'AU4', 'AU5', 'AU6', 'AU7', 'AU9', 'AU10', 'AU11', 'AU12', 
                'AU13', 'AU14', 'AU15', 'AU16', 'AU17', 'AU18', 'AU20', 'AU22', 'AU23', 'AU24', 'AU25', 'AU26', 'AU27'
            ];
            
            const actionUnitsMap = {};
            if (data.action_units) {
                data.action_units.forEach(au => {
                    actionUnitsMap[au.code] = au.value;
                });
            }
            
            // æ‰¾åˆ°å€¼æœ€é«˜çš„åŠ¨ä½œå•å…ƒ
            let maxValue = 0;
            let maxAU = null;
            
            allActionUnits.forEach(auCode => {
                const value = actionUnitsMap[auCode] || 0;
                if (value > maxValue) {
                    maxValue = value;
                    maxAU = auCode;
                }
            });
            
            tagsContainer.innerHTML = '';
            
            // åªæ˜¾ç¤ºå€¼æœ€é«˜çš„åŠ¨ä½œå•å…ƒ
            if (maxAU && maxValue > 0) {
                const auNames = {
                    'AU1': 'å†…çœ‰æ¯›æå‡', 'AU2': 'å¤–çœ‰æ¯›æå‡', 'AU4': 'çœ‰æ¯›çš±èµ·', 'AU5': 'ä¸Šçœ¼ç‘æå‡',
                    'AU6': 'è„¸é¢Šæå‡', 'AU7': 'çœ¼ç‘æ”¶ç´§', 'AU9': 'é¼»çš±', 'AU10': 'ä¸Šå”‡æå‡',
                    'AU11': 'é¼»å”‡æ²ŸåŠ æ·±', 'AU12': 'å˜´è§’æå‡', 'AU13': 'è„¸é¢Šè†¨èƒ€', 'AU14': 'é…’çª',
                    'AU15': 'å˜´è§’ä¸‹æ‹‰', 'AU16': 'ä¸‹å”‡ä¸‹æ‹‰', 'AU17': 'ä¸‹å·´æå‡', 'AU18': 'å˜´å”‡æ’…èµ·',
                    'AU20': 'å˜´è§’æ‹‰ä¼¸', 'AU22': 'å˜´å”‡æ¼æ–—çŠ¶', 'AU23': 'å˜´å”‡æ”¶ç´§', 'AU24': 'å˜´å”‡æŒ‰å‹',
                    'AU25': 'å˜´å”‡åˆ†ç¦»', 'AU26': 'ä¸‹é¢Œä¸‹å‚', 'AU27': 'å˜´éƒ¨æ‹‰ä¼¸'
                };
                
                const tag = document.createElement('span');
                tag.className = 'px-2 py-1 bg-blue-100 rounded-full text-xs text-blue-700 font-medium';
                tag.textContent = `${auNames[maxAU] || maxAU} ${Math.round(maxValue * 100)}%`;
                tagsContainer.appendChild(tag);
            } else {
                // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°åŠ¨ä½œå•å…ƒï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
                const tag = document.createElement('span');
                tag.className = 'px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-500';
                tag.textContent = 'æ— æ˜¾è‘—åŠ¨ä½œå•å…ƒ';
                tagsContainer.appendChild(tag);
            }
        }
    }
    
    // æ›´æ–°åŠ¨ä½œæ£€æµ‹æ•°æ®
    function updateMotionData(data) {
        console.log('ğŸ” å¼€å§‹æ›´æ–°åŠ¨ä½œæ•°æ®:', data);
        console.log('ğŸ” åŠ¨ä½œå¡ç‰‡å…ƒç´ :', motionCard);
        
        if (!motionCard) {
            console.error('âŒ åŠ¨ä½œå¡ç‰‡å…ƒç´ æœªæ‰¾åˆ°');
            // å°è¯•é‡æ–°è·å–DOMå…ƒç´ 
            const elements = getDOMElements();
            motionCard = elements.motionCard;
            if (!motionCard) {
                console.error('âŒ é‡æ–°è·å–åŠ¨ä½œå¡ç‰‡å¤±è´¥');
            return;
            }
        }
        
        // å¤„ç†ç©ºæ•°æ®æˆ–æ— æ•ˆæ•°æ®
        if (!data || !data.body_action) {
            console.warn('âš ï¸ åŠ¨ä½œæ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤å€¼');
            const postureText = motionCard.querySelector('.text-primary.font-medium');
            const confidenceBar = motionCard.querySelector('.h-2.bg-gray-100 .bg-primary');
            const confidenceText = motionCard.querySelector('.text-xs.text-gray-700');
            
            if (postureText) {
                postureText.textContent = 'æ­£å';
            }
            if (confidenceBar) {
                confidenceBar.style.width = '85%';
            }
            if (confidenceText) {
                confidenceText.textContent = '85%';
            }
            return;
        }
        
        console.log('ğŸ¤² æ›´æ–°åŠ¨ä½œæ•°æ®:', data.body_action);
        
        const postureText = motionCard.querySelector('.text-primary.font-medium');
        const confidenceBar = motionCard.querySelector('.h-2.bg-gray-100 .bg-primary');
        const confidenceText = motionCard.querySelector('.text-xs.text-gray-700');
        
        if (postureText) {
            postureText.textContent = data.body_action.name || 'æ­£å';
        }
        
        if (confidenceBar) {
            const confidence = Math.min(Math.round(data.body_action.confidence * 100), 100);
            confidenceBar.style.width = `${confidence}%`;
        }
        
        if (confidenceText) {
            const confidence = Math.min(Math.round(data.body_action.confidence * 100), 100);
            confidenceText.textContent = `${confidence}%`;
        }
    }
    
    // æ›´æ–°è¯­éŸ³åˆ†ææ•°æ®
    function updateVoiceData(data) {
        console.log('ğŸ” å¼€å§‹æ›´æ–°è¯­éŸ³æ•°æ®:', data);
        console.log('ğŸ” è¯­éŸ³å¡ç‰‡å…ƒç´ :', voiceCard);
        
        if (!voiceCard) {
            console.error('âŒ è¯­éŸ³å¡ç‰‡å…ƒç´ æœªæ‰¾åˆ°');
            // å°è¯•é‡æ–°è·å–DOMå…ƒç´ 
            const elements = getDOMElements();
            voiceCard = elements.voiceCard;
            if (!voiceCard) {
                console.error('âŒ é‡æ–°è·å–è¯­éŸ³å¡ç‰‡å¤±è´¥');
            return;
            }
        }
        
        // å¤„ç†ç©ºæ•°æ®æˆ–æ— æ•ˆæ•°æ®
        if (!data) {
            console.warn('âš ï¸ è¯­éŸ³æ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤å€¼');
            const emotionText = voiceCard.querySelector('.text-primary.font-medium');
            const confidenceBar = voiceCard.querySelector('.h-2.bg-gray-100 .bg-primary');
            const confidenceText = voiceCard.querySelector('.text-xs.text-gray-700');
            const voiceText = voiceCard.querySelector('.bg-gray-50.p-3.rounded-lg.text-sm.text-gray-700');
            
            if (emotionText) {
                emotionText.textContent = 'è‡ªä¿¡';
            }
            if (confidenceBar) {
                confidenceBar.style.width = '80%';
            }
            if (confidenceText) {
                confidenceText.textContent = '80%';
            }
            if (voiceText) {
                voiceText.textContent = 'ç­‰å¾…è¯­éŸ³è¾“å…¥...';
            }
            return;
        }
        
        console.log('ğŸ¤ æ›´æ–°è¯­éŸ³æ•°æ®:', data);
        
        const emotionText = voiceCard.querySelector('.text-primary.font-medium');
        const confidenceBar = voiceCard.querySelector('.h-2.bg-gray-100 .bg-primary');
        const confidenceText = voiceCard.querySelector('.text-xs.text-gray-700');
        const voiceText = voiceCard.querySelector('.bg-gray-50.p-3.rounded-lg.text-sm.text-gray-700');
        
        if (emotionText) {
            emotionText.textContent = data.emotion_cn || 'è‡ªä¿¡';
        }
        
        if (confidenceBar) {
            const confidence = Math.min(Math.round(data.confidence * 100), 100);
            confidenceBar.style.width = `${confidence}%`;
        }
        
        if (confidenceText) {
            const confidence = Math.min(Math.round(data.confidence * 100), 100);
            confidenceText.textContent = `${confidence}%`;
        }
        
        if (voiceText && data.accumulated_text) {
            voiceText.textContent = data.accumulated_text;
        }
        
        // æ›´æ–°è¯­éŸ³ç‰¹å¾ - ä½¿ç”¨æ›´å®‰å…¨çš„é€‰æ‹©å™¨
        try {
            const progressBars = voiceCard.querySelectorAll('.h-1\\.5.bg-gray-100 .bg-primary');
            if (progressBars.length >= 3 && data.tone_analysis) {
                // è¯­é€Ÿ
            const speed = data.tone_analysis.speed === 'fast' ? 90 : data.tone_analysis.speed === 'slow' ? 30 : 75;
                progressBars[0].style.width = `${speed}%`;
        
                // éŸ³è°ƒ
            const pitch = data.tone_analysis.pitch === 'high' ? 90 : data.tone_analysis.pitch === 'low' ? 30 : 82;
                progressBars[1].style.width = `${pitch}%`;
        
                // æ¸…æ™°åº¦
            const clarity = Math.round(data.tone_analysis.clarity * 100);
                progressBars[2].style.width = `${clarity}%`;
                
                console.log('âœ… è¯­éŸ³ç‰¹å¾å·²æ›´æ–°:', { speed, pitch, clarity });
            }
        } catch (error) {
            console.warn('âš ï¸ æ›´æ–°è¯­éŸ³ç‰¹å¾æ—¶å‡ºé”™:', error);
        }
    }
    
    // è®¡ç®—é¢è¯•è¯„åˆ†
    async function calculateInterviewScore() {
        try {
            const duration = analysisStartTime ? (Date.now() - analysisStartTime) / 1000 : 0;
            
            const response = await fetch(`${API_BASE_URL}/api/v1/interview/score`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                body: JSON.stringify({
                    duration: duration
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'success') {
                return result;
            } else {
                console.error('âŒ è®¡ç®—è¯„åˆ†å¤±è´¥:', result.message);
                return null;
            }
            
        } catch (error) {
            console.error('âŒ è®¡ç®—è¯„åˆ†è¯·æ±‚å¤±è´¥:', error);
            return null;
        }
    }
    
    // è·å–åˆ†æçŠ¶æ€
    async function getAnalysisStatus() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/analysis/status`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.is_running !== isAnalysisRunning) {
                isAnalysisRunning = result.is_running;
                updateAnalysisStatus(result.is_running);
            }
            
            return result;
            
        } catch (error) {
            console.error('âŒ è·å–åˆ†æçŠ¶æ€å¤±è´¥:', error);
            // æ›´æ–°è¿æ¥çŠ¶æ€
            updateConnectionStatus(false);
            return null;
        }
    }
    
    // è·å–å®æ—¶æ•°æ®ï¼ˆä¸»è¦æœºåˆ¶ï¼‰
    async function getRealtimeData() {
        try {
            // ç¡®ä¿åˆ†ææ­£åœ¨è¿è¡Œ
            if (!isAnalysisRunning) {
                console.log('ğŸ”„ åˆ†ææœªè¿è¡Œï¼Œå¯åŠ¨åˆ†æ...');
                const success = await startAnalysis();
                if (!success) {
                    console.error('âŒ æ— æ³•å¯åŠ¨åˆ†æ');
                    return;
                }
            }
            
            const response = await fetch(`${API_BASE_URL}/api/v1/data/realtime`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data) {
                console.log('ğŸ“¡ è·å–å®æ—¶æ•°æ®:', data);
                updateExpressionData(data);
                updateMotionData(data);
            } else {
                console.warn('âš ï¸ å®æ—¶æ•°æ®ä¸ºç©º');
            }
            
        } catch (error) {
            console.error('âŒ è·å–å®æ—¶æ•°æ®å¤±è´¥:', error);
        }
    }
    
    // è·å–è¯­éŸ³å®æ—¶æ•°æ®ï¼ˆä¸»è¦æœºåˆ¶ï¼‰
    async function getVoiceRealtimeData() {
        try {
            // ç¡®ä¿è¯­éŸ³åˆ†ææ­£åœ¨è¿è¡Œ
            if (!isVoiceAnalysisRunning) {
                console.log('ğŸ”„ è¯­éŸ³åˆ†ææœªè¿è¡Œï¼Œå¯åŠ¨è¯­éŸ³åˆ†æ...');
                const success = await startVoiceAnalysis();
                if (!success) {
                    console.error('âŒ æ— æ³•å¯åŠ¨è¯­éŸ³åˆ†æ');
                    return;
                }
            }
            
            const response = await fetch(`${API_BASE_URL}/api/v1/voice/realtime`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data) {
                console.log('ğŸ“¡ è·å–è¯­éŸ³æ•°æ®:', data);
                updateVoiceData(data);
            } else {
                console.warn('âš ï¸ è¯­éŸ³æ•°æ®ä¸ºç©º');
            }
            
        } catch (error) {
            console.error('âŒ è·å–è¯­éŸ³å®æ—¶æ•°æ®å¤±è´¥:', error);
        }
    }
    
    // ç¡®ä¿åˆ†æå·²å¯åŠ¨
    async function ensureAnalysisRunning() {
        if (!isAnalysisRunning) {
            console.log('ğŸ”„ åˆ†ææœªè¿è¡Œï¼Œæ­£åœ¨å¯åŠ¨...');
            const success = await startAnalysis();
            if (!success) {
                console.error('âŒ æ— æ³•å¯åŠ¨åˆ†æ');
                return false;
            }
        }
        return true;
    }
    
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    function bindButtonEvents() {
        // é¡¶éƒ¨å¯åŠ¨åˆ†ææŒ‰é’®
        const startAnalysisBtn = document.getElementById('start-analysis-btn');
        if (startAnalysisBtn) {
            startAnalysisBtn.addEventListener('click', async function() {
                if (!isAnalysisRunning) {
                    // å¯åŠ¨åˆ†æ
                    console.log('ğŸ”„ æ‰‹åŠ¨å¯åŠ¨åˆ†æ...');
                    const success = await startAnalysis();
                    if (success) {
                        console.log('âœ… åˆ†æå¯åŠ¨æˆåŠŸ');
                        // å¯åŠ¨è¯­éŸ³åˆ†æ
                        await startVoiceAnalysis();
                        // ç«‹å³è·å–æ•°æ®
                        getRealtimeData();
                        getVoiceRealtimeData();
                    } else {
                        console.error('âŒ åˆ†æå¯åŠ¨å¤±è´¥');
                    }
                } else {
                    // åœæ­¢åˆ†æ
                    console.log('ğŸ”„ æ‰‹åŠ¨åœæ­¢åˆ†æ...');
                    const success = await stopAnalysis();
                    if (success) {
                        console.log('âœ… åˆ†æåœæ­¢æˆåŠŸ');
                    } else {
                        console.error('âŒ åˆ†æåœæ­¢å¤±è´¥');
                    }
                }
            });
        }
        
        // æš‚åœ/ç»§ç»­é¢è¯•æŒ‰é’®
        const pauseButton = document.querySelector('button:has(i.ri-pause-line)');
        if (pauseButton) {
            pauseButton.addEventListener('click', async function() {
                if (!isAnalysisRunning) {
                    // å¯åŠ¨åˆ†æ
                    const success = await startAnalysis();
                    if (success) {
                        const icon = this.querySelector('i');
                        const text = this.querySelector('span');
                        icon.classList.remove('ri-pause-line');
                        icon.classList.add('ri-play-line');
                        text.textContent = 'ç»§ç»­é¢è¯•';
                    }
                } else {
                    // æš‚åœåˆ†æ
                    const success = await stopAnalysis();
                    if (success) {
                        const icon = this.querySelector('i');
                        const text = this.querySelector('span');
                        icon.classList.remove('ri-play-line');
                        icon.classList.add('ri-pause-line');
                        text.textContent = 'æš‚åœé¢è¯•';
                    }
                }
            });
        }
        
        // ç»“æŸé¢è¯•æŒ‰é’®
        const endButton = document.querySelector('button:has(i.ri-close-line)');
        if (endButton) {
            endButton.addEventListener('click', async function() {
                if (isAnalysisRunning) {
                    await stopAnalysis();
                }
                
                // è®¡ç®—è¯„åˆ†å¹¶æ˜¾ç¤ºæŠ¥å‘Š
                const scoreResult = await calculateInterviewScore();
                if (scoreResult) {
                    showInterviewReport(scoreResult);
                }
            });
        }
        
        // éº¦å…‹é£å¼€å…³
        const micToggle = document.querySelector('input[type="checkbox"]');
        if (micToggle) {
            micToggle.addEventListener('change', async function() {
                if (this.checked) {
                    // æ£€æŸ¥éº¦å…‹é£æƒé™
                    if (!microphonePermissionGranted) {
                        const granted = await requestMicrophonePermission();
                        if (!granted) {
                            this.checked = false; // å–æ¶ˆé€‰ä¸­
                            return;
                        }
                    }
                    
                    // è·å–éº¦å…‹é£æµ
                    const stream = await getMicrophoneStream();
                    if (!stream) {
                        this.checked = false; // å–æ¶ˆé€‰ä¸­
                        return;
                    }
                    
                    // å¯åŠ¨è¯­éŸ³åˆ†æ
                    if (!isVoiceAnalysisRunning) {
                        const success = await startVoiceAnalysis();
                        if (!success) {
                            this.checked = false; // å–æ¶ˆé€‰ä¸­
                        }
                    }
                } else {
                    // åœæ­¢è¯­éŸ³åˆ†æ
                    if (isVoiceAnalysisRunning) {
                        await stopVoiceAnalysis();
                    }
                    
                    // åœæ­¢éº¦å…‹é£æµ
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                        audioStream = null;
                    }
                }
            });
        }
    }
    
    // æ˜¾ç¤ºé¢è¯•æŠ¥å‘Š
    function showInterviewReport(scoreResult) {
        const reportDialog = document.createElement('div');
        reportDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        
        const detailedScores = scoreResult.detailed_scores || {};
        const analysisStats = scoreResult.analysis_stats || {};
        
        reportDialog.innerHTML = `
            <div class="bg-white rounded-lg w-[800px] max-h-[80vh] overflow-y-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-medium text-gray-900">é¢è¯•è¯„æµ‹æŠ¥å‘Š</h2>
                    <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.fixed').remove()">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
                <div class="space-y-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium text-gray-900 mb-2">æ•´ä½“è¡¨ç°è¯„åˆ†</h3>
                        <div class="flex items-center space-x-2">
                            <div class="text-3xl font-medium text-primary">${scoreResult.overall_score}</div>
                            <div class="text-gray-500">/ 100</div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900 mb-3">è¯¦ç»†è¯„ä¼°</h3>
                        <div class="space-y-4">
                            ${Object.entries(detailedScores).map(([key, value]) => `
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-700">${key}</span>
                                    <div class="w-48 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-primary" style="width: ${value}%"></div>
                                    </div>
                                    <span class="text-gray-900">${value}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900 mb-3">åˆ†æç»Ÿè®¡</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>é¢è¯•æ—¶é•¿: ${Math.round(analysisStats.duration || 0)}ç§’</div>
                            <div>å¤„ç†å¸§æ•°: ${analysisStats.frame_count || 0}</div>
                            <div>è¡¨æƒ…æ£€æµ‹: ${analysisStats.expression_count || 0}æ¬¡</div>
                            <div>åŠ¨ä½œæ£€æµ‹: ${analysisStats.body_count || 0}æ¬¡</div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded-button hover:bg-gray-300 transition-colors" onclick="this.closest('.fixed').remove()">
                        å…³é—­
                    </button>
                    <div class="flex space-x-3">
                        <button class="bg-primary text-white px-4 py-2 rounded-button hover:bg-opacity-90 transition-colors" id="viewReportBtn">
                            æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
                        </button>
                        <button class="bg-green-500 text-white px-4 py-2 rounded-button hover:bg-opacity-90 transition-colors" id="downloadReportBtn">
                            ä¸‹è½½æŠ¥å‘Š
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(reportDialog);
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        setTimeout(() => {
            const viewReportBtn = document.getElementById('viewReportBtn');
            const downloadReportBtn = document.getElementById('downloadReportBtn');
            
            if (viewReportBtn) {
                viewReportBtn.addEventListener('click', viewInterviewReport);
            }
            if (downloadReportBtn) {
                downloadReportBtn.addEventListener('click', downloadReport);
            }
        }, 100);
    }
    
    // æŸ¥çœ‹é¢è¯•æŠ¥å‘Šï¼ˆè·³è½¬åˆ°é™æ€æŠ¥å‘Šé¡µé¢ï¼Œä»åç«¯è·å–æ•°æ®ï¼‰
    function viewInterviewReport() {
        try {
            // è·å–é¢è¯•å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const tech_field = urlParams.get('tech_field') || 'äººå·¥æ™ºèƒ½';
            const position = urlParams.get('position') || 'æŠ€æœ¯å²—';
            const candidate_name = urlParams.get('candidate_name') || 'å¼ æ˜è¿œ';
            const duration_minutes = Math.round((Date.now() - interviewStartTime) / (1000 * 60)) || 45;
            
            // æ„å»ºæŠ¥å‘Šé¡µé¢URLï¼Œä¼ é€’é¢è¯•å‚æ•°
            const reportParams = new URLSearchParams({
                tech_field: tech_field,
                position: position,
                candidate_name: candidate_name,
                duration_minutes: duration_minutes.toString()
            });
            
            const reportUrl = `/report?${reportParams.toString()}`;
            
            // å…³é—­å½“å‰å¯¹è¯æ¡†
            const dialog = document.querySelector('.fixed.inset-0');
            if (dialog) {
                dialog.remove();
            }
            
            // è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢
            window.location.href = reportUrl;
            
        } catch (error) {
            console.error('è·³è½¬æŠ¥å‘Šé¡µé¢å¤±è´¥:', error);
            alert('è·³è½¬æŠ¥å‘Šé¡µé¢å¤±è´¥: ' + error.message);
        }
    }
    
    // ä¸‹è½½æŠ¥å‘Š
    async function downloadReport() {
        try {
            // è·å–é¢è¯•å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const tech_field = urlParams.get('tech_field') || 'äººå·¥æ™ºèƒ½';
            const position = urlParams.get('position') || 'æŠ€æœ¯å²—';
            const candidate_name = urlParams.get('candidate_name') || 'å¼ æ˜è¿œ';
            
            // ç”ŸæˆæŠ¥å‘Š
            const response = await fetch('/api/v1/reports/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tech_field: tech_field,
                    position: position,
                    duration_minutes: Math.round((Date.now() - interviewStartTime) / (1000 * 60)) || 45,
                    candidate_name: candidate_name
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                const report = result.report;
                
                // ç”ŸæˆæŠ¥å‘Šæ–‡æœ¬
                const reportText = generateReportText(report);
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `é¢è¯•æŠ¥å‘Š_${report.basic_info.report_id}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('ä¸‹è½½æŠ¥å‘Šå¤±è´¥:', error);
            alert('ä¸‹è½½æŠ¥å‘Šå¤±è´¥: ' + error.message);
        }
    }
    
    // ç”ŸæˆæŠ¥å‘Šæ–‡æœ¬
    function generateReportText(report) {
        return `é¢è¯•è¯„ä¼°æŠ¥å‘Š
        
æŠ¥å‘ŠID: ${report.basic_info.report_id}
é¢è¯•æ—¶é—´: ${report.basic_info.interview_time}
å²—ä½: ${report.basic_info.position}
åº”è˜è€…: ${report.basic_info.candidate_name}
ç»¼åˆè¯„åˆ†: ${report.core_competencies.overall_score}åˆ†
ç­‰çº§: ${report.basic_info.overall_grade}

è¯¦ç»†è¯„åˆ†:
ä¸“ä¸šçŸ¥è¯†æ°´å¹³: ${report.core_competencies.detailed_scores.professional_knowledge.score}åˆ† - ${report.core_competencies.detailed_scores.professional_knowledge.level}
æŠ€èƒ½åŒ¹é…åº¦: ${report.core_competencies.detailed_scores.skill_matching.score}åˆ† - ${report.core_competencies.detailed_scores.skill_matching.level}
è¯­è¨€è¡¨è¾¾èƒ½åŠ›: ${report.core_competencies.detailed_scores.language_expression.score}åˆ† - ${report.core_competencies.detailed_scores.language_expression.level}
é€»è¾‘æ€ç»´èƒ½åŠ›: ${report.core_competencies.detailed_scores.logical_thinking.score}åˆ† - ${report.core_competencies.detailed_scores.logical_thinking.level}
åˆ›æ–°èƒ½åŠ›: ${report.core_competencies.detailed_scores.innovation_ability.score}åˆ† - ${report.core_competencies.detailed_scores.innovation_ability.level}
åº”å˜æŠ—å‹èƒ½åŠ›: ${report.core_competencies.detailed_scores.stress_resistance.score}åˆ† - ${report.core_competencies.detailed_scores.stress_resistance.level}

ä¼˜åŠ¿èƒ½åŠ›:
${report.strengths_weaknesses.strengths.map(item => `â€¢ ${item.title}: ${item.description}`).join('\n')}

éœ€æå‡èƒ½åŠ›:
${report.strengths_weaknesses.weaknesses.map(item => `â€¢ ${item.title}: ${item.description}`).join('\n')}

æå‡å»ºè®®:
å­¦ä¹ èµ„æº:
${report.improvement_suggestions.learning_resources.map(item => `â€¢ ${item.title}: ${item.description}`).join('\n')}

æå‡æ–¹æ³•:
${report.improvement_suggestions.improvement_methods.map(item => `â€¢ ${item.title}: ${item.description}`).join('\n')}

æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${report.metadata.generated_at}
`;
    }
    
    // æ·»åŠ é¢è¯•å¼€å§‹æ—¶é—´è®°å½•
    let interviewStartTime = Date.now();
    
    // åˆå§‹åŒ–
    function init() {
        console.log('ğŸš€ åˆå§‹åŒ–Flask APIé›†æˆ...');
        console.log('ğŸ“¡ APIåœ°å€:', API_BASE_URL);
        console.log('ğŸ”Œ WebSocketåœ°å€:', SOCKET_URL);
        
        // ç«‹å³è·å–DOMå…ƒç´ 
            const elements = getDOMElements();
            expressionCard = elements.expressionCard;
            motionCard = elements.motionCard;
            voiceCard = elements.voiceCard;
        
        console.log('ğŸ” DOMå…ƒç´ åˆå§‹åŒ–ç»“æœ:');
        console.log('  è¡¨æƒ…å¡ç‰‡:', expressionCard);
        console.log('  åŠ¨ä½œå¡ç‰‡:', motionCard);
        console.log('  è¯­éŸ³å¡ç‰‡:', voiceCard);
        
        // å¦‚æœDOMå…ƒç´ æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿé‡è¯•
        if (!expressionCard || !motionCard || !voiceCard) {
            console.log('ğŸ”„ DOMå…ƒç´ æœªå®Œå…¨åŠ è½½ï¼Œå»¶è¿Ÿé‡è¯•...');
            setTimeout(() => {
                const retryElements = getDOMElements();
                expressionCard = retryElements.expressionCard;
                motionCard = retryElements.motionCard;
                voiceCard = retryElements.voiceCard;
                console.log('ğŸ”„ é‡è¯•åDOMå…ƒç´ :', { expressionCard, motionCard, voiceCard });
            }, 2000);
        }
        
        // åˆå§‹åŒ–WebSocket
        initSocket();
        
        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        bindButtonEvents();
        
        // ç«‹å³æ£€æŸ¥ä¸€æ¬¡è¿æ¥çŠ¶æ€å¹¶å¯åŠ¨åˆ†æ
        getAnalysisStatus().then(async result => {
            if (result) {
                console.log('âœ… åç«¯è¿æ¥æ­£å¸¸');
                updateConnectionStatus(true);
                
                // å¦‚æœåˆ†ææ²¡æœ‰è¿è¡Œï¼Œè‡ªåŠ¨å¯åŠ¨
                if (!result.is_running) {
                    console.log('ğŸ”„ åˆ†ææœªè¿è¡Œï¼Œè‡ªåŠ¨å¯åŠ¨åˆ†æ...');
                    const success = await startAnalysis();
                    if (success) {
                        console.log('âœ… åˆ†æå¯åŠ¨æˆåŠŸ');
                        // å¯åŠ¨è¯­éŸ³åˆ†æ
                        await startVoiceAnalysis();
                    } else {
                        console.error('âŒ åˆ†æå¯åŠ¨å¤±è´¥');
                    }
                } else {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°åˆ†ææ­£åœ¨è¿è¡Œ');
                }
                
                // ç«‹å³è·å–ä¸€æ¬¡å®æ—¶æ•°æ®
                console.log('ğŸ“¡ è·å–å®æ—¶æ•°æ®...');
                getRealtimeData();
                getVoiceRealtimeData();
            } else {
                console.warn('âš ï¸ åç«¯è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
                updateConnectionStatus(false);
            }
        });
        
        // å®šæœŸæ£€æŸ¥åˆ†æçŠ¶æ€å’Œè·å–å®æ—¶æ•°æ® - ä½¿ç”¨FPSè®¾ç½®æ§åˆ¶
        const settings = loadSettings();
        // ä½¿ç”¨1ç§’é—´éš”ï¼Œå› ä¸ºè¡¨æƒ…å’ŒåŠ¨ä½œæ£€æµ‹éƒ½è®¾ç½®ä¸º1fps
        const updateInterval = 1000;
        
        window.dataUpdateInterval = setInterval(async () => {
            const result = await getAnalysisStatus();
            if (result) {
                updateConnectionStatus(true);
                
                // ç¡®ä¿åˆ†ææ­£åœ¨è¿è¡Œ
                if (!result.is_running && !isAnalysisRunning) {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°åˆ†æåœæ­¢ï¼Œé‡æ–°å¯åŠ¨...');
                    await startAnalysis();
                    await startVoiceAnalysis();
                }
                
                // æ ¹æ®FPSè®¾ç½®è·å–æ•°æ® - è¡¨æƒ…å’ŒåŠ¨ä½œæ£€æµ‹éƒ½æ˜¯1fps
                const now = Date.now();
                if (!window.lastExpressionUpdate || now - window.lastExpressionUpdate >= 1000) {
                    getRealtimeData();
                    window.lastExpressionUpdate = now;
                }
                
                if (!window.lastVoiceUpdate || now - window.lastVoiceUpdate >= 1000 / settings.voiceFps) {
                    getVoiceRealtimeData();
                    window.lastVoiceUpdate = now;
                }
                
                // å¦‚æœWebSocketè¿æ¥å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
                if (!socket || !socket.connected) {
                    console.log('ğŸ”„ WebSocketæœªè¿æ¥ï¼Œä½¿ç”¨HTTPè½®è¯¢...');
                }
            }
        }, updateInterval);
        
        console.log('âœ… Flask APIé›†æˆåˆå§‹åŒ–å®Œæˆ');
        console.log('ğŸ“Š å½“å‰FPSè®¾ç½®:');
        console.log('  è¡¨æƒ…æ£€æµ‹: 1 FPS');
        console.log('  åŠ¨ä½œæ£€æµ‹: 1 FPS');
        console.log('  è¯­éŸ³åˆ†æ: 5 FPS');
        console.log('  æ›´æ–°é—´éš”: 1000ms');
    }
    
    // æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
    function showSettingsDialog() {
        console.log('æ­£åœ¨æ‰“å¼€è®¾ç½®é¢æ¿...');
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®¾ç½®é¢æ¿ï¼Œå¦‚æœæœ‰åˆ™ç§»é™¤
        const existingDialog = document.querySelector('.settings-dialog');
        if (existingDialog) {
            existingDialog.remove();
        }
        
        const settingsDialog = document.createElement('div');
        settingsDialog.className = 'settings-dialog fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
        settingsDialog.style.zIndex = '9999';
        
        settingsDialog.innerHTML = `
            <div class="bg-white rounded-lg w-[600px] max-h-[85vh] overflow-y-auto shadow-xl">
                <div class="flex justify-between items-center mb-6 p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-medium text-gray-900">ç³»ç»Ÿè®¾ç½®</h2>
                    <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.fixed').remove()">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6 space-y-8">
                    <!-- æ£€æµ‹é¢‘ç‡è®¾ç½® -->
                    <div>
                        <h3 class="font-medium text-gray-900 mb-4 flex items-center">
                            <i class="ri-speed-line mr-2 text-primary"></i>
                            æ£€æµ‹é¢‘ç‡è®¾ç½®
                        </h3>
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    è¡¨æƒ…æ£€æµ‹ FPS: <span id="expression-fps-value">1</span>
                                </label>
                                <input type="range" id="expression-fps-slider" min="1" max="30" value="1" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>1 FPS</span>
                                    <span>30 FPS</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    åŠ¨ä½œæ£€æµ‹ FPS: <span id="motion-fps-value">1</span>
                                </label>
                                <input type="range" id="motion-fps-slider" min="1" max="20" value="1" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>1 FPS</span>
                                    <span>20 FPS</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    è¯­éŸ³åˆ†æ FPS: <span id="voice-fps-value">5</span>
                                </label>
                                <input type="range" id="voice-fps-slider" min="1" max="10" value="5" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>1 FPS</span>
                                    <span>10 FPS</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŠŸèƒ½å¼€å…³è®¾ç½® -->
                    <div>
                        <h3 class="font-medium text-gray-900 mb-4 flex items-center">
                            <i class="ri-toggle-line mr-2 text-primary"></i>
                            åŠŸèƒ½å¼€å…³è®¾ç½®
                        </h3>
                        <div class="space-y-4">
                            <!-- é¢è¯•å®˜é—®é¢˜æ˜¾ç¤ºé…ç½® -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-900">é¢è¯•å®˜é—®é¢˜æ˜¾ç¤º</h4>
                                        <p class="text-sm text-gray-600 mt-1">æ§åˆ¶é¢è¯•å®˜é—®é¢˜æ–‡æœ¬çš„æ˜¾ç¤ºçŠ¶æ€</p>
                                    </div>
                                    <label class="custom-switch">
                                        <input type="checkbox" id="question-toggle" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-700">å½“å‰çŠ¶æ€ï¼š<span id="question-status" class="font-medium text-green-600">å·²å¯ç”¨</span></p>
                                    <p class="text-xs text-gray-500 mt-1">é¢è¯•å®˜çš„é—®é¢˜å°†å®æ—¶æ˜¾ç¤ºåœ¨å·¦ä¾§é¢æ¿ä¸­</p>
                                </div>
                            </div>
                            
                            <!-- è¡¨æƒ…æ£€æµ‹é…ç½® - é»˜è®¤å¯ç”¨ -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-900">è¡¨æƒ…æ£€æµ‹</h4>
                                        <p class="text-sm text-gray-600 mt-1">å®æ—¶åˆ†æé¢éƒ¨è¡¨æƒ…å˜åŒ–</p>
                                    </div>
                                    <div class="text-green-600 text-sm font-medium">
                                        <i class="ri-check-line mr-1"></i>é»˜è®¤å¯ç”¨
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-700">å½“å‰çŠ¶æ€ï¼š<span class="font-medium text-green-600">å·²å¯ç”¨</span></p>
                                    <p class="text-xs text-gray-500 mt-1">å®æ—¶æ£€æµ‹ç”¨æˆ·çš„é¢éƒ¨è¡¨æƒ…å’Œæƒ…ç»ªçŠ¶æ€</p>
                                </div>
                            </div>
                            
                            <!-- åŠ¨ä½œæ£€æµ‹é…ç½® - é»˜è®¤å¯ç”¨ -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-900">åŠ¨ä½œæ£€æµ‹</h4>
                                        <p class="text-sm text-gray-600 mt-1">ç›‘æµ‹è‚¢ä½“è¯­è¨€å’Œå§¿æ€å˜åŒ–</p>
                                    </div>
                                    <div class="text-green-600 text-sm font-medium">
                                        <i class="ri-check-line mr-1"></i>é»˜è®¤å¯ç”¨
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-700">å½“å‰çŠ¶æ€ï¼š<span class="font-medium text-green-600">å·²å¯ç”¨</span></p>
                                    <p class="text-xs text-gray-500 mt-1">æ£€æµ‹ç”¨æˆ·çš„èº«ä½“åŠ¨ä½œã€å§¿æ€å’Œæ‰‹åŠ¿</p>
                                </div>
                            </div>
                            
                            <!-- è¯­éŸ³æƒ…æ„Ÿåˆ†æé…ç½® - é»˜è®¤å¯ç”¨ -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-900">è¯­éŸ³æƒ…æ„Ÿåˆ†æ</h4>
                                        <p class="text-sm text-gray-600 mt-1">åˆ†æè¯­éŸ³æƒ…æ„Ÿå’Œè¯­è¨€ç‰¹å¾</p>
                                    </div>
                                    <div class="text-green-600 text-sm font-medium">
                                        <i class="ri-check-line mr-1"></i>é»˜è®¤å¯ç”¨
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-700">å½“å‰çŠ¶æ€ï¼š<span class="font-medium text-green-600">å·²å¯ç”¨</span></p>
                                    <p class="text-xs text-gray-500 mt-1">åˆ†æè¯­éŸ³æƒ…æ„Ÿã€è¯­é€Ÿã€éŸ³è°ƒå’Œæ¸…æ™°åº¦</p>
                                </div>
                            </div>
                            
                            <!-- å®æ—¶æç¤ºé…ç½® -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-900">å®æ—¶æç¤º</h4>
                                        <p class="text-sm text-gray-600 mt-1">æ˜¾ç¤ºå›ç­”å»ºè®®å’Œå‚è€ƒè¦ç‚¹</p>
                                    </div>
                                    <label class="custom-switch">
                                        <input type="checkbox" id="tips-toggle" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-700">å½“å‰çŠ¶æ€ï¼š<span id="tips-status" class="font-medium text-green-600">å·²å¯ç”¨</span></p>
                                    <p class="text-xs text-gray-500 mt-1">æä¾›é¢è¯•å›ç­”çš„å»ºè®®å’Œå‚è€ƒè¦ç‚¹</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ˜¾ç¤ºè®¾ç½® -->
                    <div>
                        <h3 class="font-medium text-gray-900 mb-4 flex items-center">
                            <i class="ri-eye-line mr-2 text-primary"></i>
                            æ˜¾ç¤ºè®¾ç½®
                        </h3>
                        <div class="space-y-3 bg-gray-50 p-4 rounded-lg">
                            <label class="flex items-center">
                                <input type="checkbox" id="show-all-actions" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                                <span class="ml-2 text-sm text-gray-700">æ˜¾ç¤ºæ‰€æœ‰åŠ¨ä½œå•å…ƒï¼ˆå³ä½¿å€¼ä¸º0ï¼‰</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="auto-start-analysis" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                                <span class="ml-2 text-sm text-gray-700">é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¯åŠ¨åˆ†æ</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-websocket" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                                <span class="ml-2 text-sm text-gray-700">å¯ç”¨WebSocketå®æ—¶é€šä¿¡</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200 flex space-x-3 p-6">
                    <button class="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-button hover:bg-gray-200 transition-colors" id="reset-settings">
                        æ¢å¤é»˜è®¤
                    </button>
                    <button class="flex-1 bg-primary text-white px-4 py-2 rounded-button hover:bg-opacity-90 transition-colors" onclick="saveSettings()">
                        ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­é¢æ¿
        settingsDialog.addEventListener('click', function(e) {
            if (e.target === settingsDialog) {
                settingsDialog.remove();
            }
        });
        
        document.body.appendChild(settingsDialog);
        
        // ç»‘å®šæ»‘å—äº‹ä»¶
        bindSettingsEvents();
        
        // ç»‘å®šå¼€å…³äº‹ä»¶
        bindToggleEvents();
        
        console.log('âœ… ç»Ÿä¸€è®¾ç½®é¢æ¿å·²æ˜¾ç¤º');
    }
    
    // ç»‘å®šè®¾ç½®äº‹ä»¶
    function bindSettingsEvents() {
        const expressionSlider = document.getElementById('expression-fps-slider');
        const motionSlider = document.getElementById('motion-fps-slider');
        const voiceSlider = document.getElementById('voice-fps-slider');
        
        if (expressionSlider) {
            expressionSlider.addEventListener('input', function() {
                document.getElementById('expression-fps-value').textContent = this.value;
            });
        }
        
        if (motionSlider) {
            motionSlider.addEventListener('input', function() {
                document.getElementById('motion-fps-value').textContent = this.value;
            });
        }
        
        if (voiceSlider) {
            voiceSlider.addEventListener('input', function() {
                document.getElementById('voice-fps-value').textContent = this.value;
            });
        }
    }
    
    // ç»‘å®šå¼€å…³äº‹ä»¶
    function bindToggleEvents() {
        // é¢è¯•å®˜é—®é¢˜æ˜¾ç¤ºå¼€å…³
        const questionToggle = document.getElementById('question-toggle');
        if (questionToggle) {
            questionToggle.addEventListener('change', function() {
                const status = document.getElementById('question-status');
                if (this.checked) {
                    status.textContent = 'å·²å¯ç”¨';
                    status.className = 'font-medium text-green-600';
                } else {
                    status.textContent = 'å·²ç¦ç”¨';
                    status.className = 'font-medium text-red-600';
                }
            });
        }
        
        // è¡¨æƒ…æ£€æµ‹ã€åŠ¨ä½œæ£€æµ‹ã€è¯­éŸ³æƒ…æ„Ÿåˆ†æ - é»˜è®¤å¯ç”¨ï¼Œæ— éœ€å¼€å…³
        
        // å®æ—¶æç¤ºå¼€å…³
        const tipsToggle = document.getElementById('tips-toggle');
        if (tipsToggle) {
            tipsToggle.addEventListener('change', function() {
                const status = document.getElementById('tips-status');
                if (this.checked) {
                    status.textContent = 'å·²å¯ç”¨';
                    status.className = 'font-medium text-green-600';
                } else {
                    status.textContent = 'å·²ç¦ç”¨';
                    status.className = 'font-medium text-red-600';
                }
            });
        }
        
        // æ¢å¤é»˜è®¤æŒ‰é’®
        const resetBtn = document.getElementById('reset-settings');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                resetToDefaults();
            });
        }
    }
    
    // æ¢å¤é»˜è®¤è®¾ç½®
    function resetToDefaults() {
        // é‡ç½®FPSæ»‘å—
        const expressionSlider = document.getElementById('expression-fps-slider');
        const motionSlider = document.getElementById('motion-fps-slider');
        const voiceSlider = document.getElementById('voice-fps-slider');
        
        if (expressionSlider) {
            expressionSlider.value = 1;
            document.getElementById('expression-fps-value').textContent = '1';
        }
        
        if (motionSlider) {
            motionSlider.value = 1;
            document.getElementById('motion-fps-value').textContent = '1';
        }
        
        if (voiceSlider) {
            voiceSlider.value = 5;
            document.getElementById('voice-fps-value').textContent = '5';
        }
        
        // é‡ç½®å¼€å…³ï¼ˆä»…ä¿ç•™é—®é¢˜æ˜¾ç¤ºå’Œå®æ—¶æç¤ºï¼‰
        const toggles = ['question-toggle', 'tips-toggle'];
        toggles.forEach(id => {
            const toggle = document.getElementById(id);
            if (toggle) {
                toggle.checked = true;
                const status = document.getElementById(id.replace('-toggle', '-status'));
                if (status) {
                    status.textContent = 'å·²å¯ç”¨';
                    status.className = 'font-medium text-green-600';
                }
            }
        });
        
        // é‡ç½®å¤é€‰æ¡†
        const checkboxes = ['show-all-actions', 'auto-start-analysis', 'enable-websocket'];
        checkboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        
        console.log('âœ… è®¾ç½®å·²æ¢å¤é»˜è®¤å€¼');
    }
    
    // ä¿å­˜è®¾ç½®
    function saveSettings() {
        try {
            console.log('ğŸ”„ å¼€å§‹ä¿å­˜è®¾ç½®...');
            
            // è·å–æ‰€æœ‰è®¾ç½®å…ƒç´ 
            const expressionFpsSlider = document.getElementById('expression-fps-slider');
            const motionFpsSlider = document.getElementById('motion-fps-slider');
            const voiceFpsSlider = document.getElementById('voice-fps-slider');
            const questionToggle = document.getElementById('question-toggle');
            const tipsToggle = document.getElementById('tips-toggle');
            const showAllActions = document.getElementById('show-all-actions');
            const autoStartAnalysis = document.getElementById('auto-start-analysis');
            const enableWebSocket = document.getElementById('enable-websocket');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!expressionFpsSlider || !motionFpsSlider || !voiceFpsSlider) {
                console.error('âŒ FPSæ»‘å—å…ƒç´ æœªæ‰¾åˆ°');
                showNotification('è®¾ç½®ä¿å­˜å¤±è´¥ï¼šFPSæ»‘å—æœªæ‰¾åˆ°', 'error');
                return;
            }
            
            if (!questionToggle || !tipsToggle) {
                console.error('âŒ åŠŸèƒ½å¼€å…³å…ƒç´ æœªæ‰¾åˆ°');
                showNotification('è®¾ç½®ä¿å­˜å¤±è´¥ï¼šåŠŸèƒ½å¼€å…³æœªæ‰¾åˆ°', 'error');
                return;
            }
            
        const settings = {
                // FPSè®¾ç½®
                expressionFps: parseInt(expressionFpsSlider.value) || 1,
                motionFps: parseInt(motionFpsSlider.value) || 1,
                voiceFps: parseInt(voiceFpsSlider.value) || 5,
                
                // åŠŸèƒ½å¼€å…³è®¾ç½®ï¼ˆè¡¨æƒ…/åŠ¨ä½œ/è¯­éŸ³æ£€æµ‹é»˜è®¤å¯ç”¨ï¼‰
                questionDisplay: questionToggle.checked,
                expressionDetection: true,  // é»˜è®¤å¯ç”¨
                motionDetection: true,      // é»˜è®¤å¯ç”¨
                voiceAnalysis: true,        // é»˜è®¤å¯ç”¨
                realtimeTips: tipsToggle.checked,
                
                // æ˜¾ç¤ºè®¾ç½®
                showAllActions: showAllActions ? showAllActions.checked : true,
                autoStartAnalysis: autoStartAnalysis ? autoStartAnalysis.checked : true,
                enableWebSocket: enableWebSocket ? enableWebSocket.checked : true
            };
            
            console.log('ğŸ“Š æ”¶é›†åˆ°çš„è®¾ç½®:', settings);
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('interviewSettings', JSON.stringify(settings));
        
        // åº”ç”¨è®¾ç½®
        applySettings(settings);
        
        // å…³é—­å¯¹è¯æ¡†
            const dialog = document.querySelector('.settings-dialog');
            if (dialog) {
                dialog.remove();
            } else {
                // å¤‡ç”¨å…³é—­æ–¹æ³•
                const fixedElements = document.querySelectorAll('.fixed');
                fixedElements.forEach(el => {
                    if (el.classList.contains('settings-dialog') || el.querySelector('.settings-dialog')) {
                        el.remove();
                    }
                });
            }
            
            console.log('âœ… ç»Ÿä¸€è®¾ç½®å·²ä¿å­˜:', settings);
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            showNotification('è®¾ç½®å·²ä¿å­˜', 'success');
            
        } catch (error) {
            console.error('âŒ ä¿å­˜è®¾ç½®æ—¶å‡ºé”™:', error);
            showNotification('è®¾ç½®ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
        }
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all duration-300 ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // åº”ç”¨è®¾ç½®
    function applySettings(settings) {
        // æ›´æ–°FPSè®¾ç½®
        window.expressionFps = settings.expressionFps;
        window.motionFps = settings.motionFps;
        window.voiceFps = settings.voiceFps;
        
        // æ›´æ–°åŠŸèƒ½å¼€å…³è®¾ç½®ï¼ˆè¡¨æƒ…/åŠ¨ä½œ/è¯­éŸ³æ£€æµ‹é»˜è®¤å¯ç”¨ï¼‰
        window.questionDisplay = settings.questionDisplay;
        window.expressionDetection = true;  // é»˜è®¤å¯ç”¨
        window.motionDetection = true;      // é»˜è®¤å¯ç”¨
        window.voiceAnalysis = true;        // é»˜è®¤å¯ç”¨
        window.realtimeTips = settings.realtimeTips;
        
        // æ›´æ–°æ˜¾ç¤ºè®¾ç½®
        window.showAllActions = settings.showAllActions;
        window.autoStartAnalysis = settings.autoStartAnalysis;
        window.enableWebSocket = settings.enableWebSocket;
        
        // åº”ç”¨åŠŸèƒ½å¼€å…³è®¾ç½®
        applyFeatureToggles(settings);
        
        // é‡æ–°è°ƒæ•´å®šæ—¶å™¨
        if (window.dataUpdateInterval) {
            clearInterval(window.dataUpdateInterval);
        }
        
        // æ ¹æ®è®¾ç½®è°ƒæ•´æ›´æ–°é¢‘ç‡
        const updateInterval = 1000;
        window.dataUpdateInterval = setInterval(async () => {
            const result = await getAnalysisStatus();
            if (result) {
                updateConnectionStatus(true);
                
                // ç¡®ä¿åˆ†ææ­£åœ¨è¿è¡Œ
                if (!result.is_running && !isAnalysisRunning) {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°åˆ†æåœæ­¢ï¼Œé‡æ–°å¯åŠ¨...');
                    await startAnalysis();
                    await startVoiceAnalysis();
                }
                
                // æ ¹æ®FPSè®¾ç½®è·å–æ•°æ®
                const now = Date.now();
                if (!window.lastExpressionUpdate || now - window.lastExpressionUpdate >= 1000) {
                    getRealtimeData();
                    window.lastExpressionUpdate = now;
                }
                
                if (!window.lastVoiceUpdate || now - window.lastVoiceUpdate >= 1000 / settings.voiceFps) {
                    getVoiceRealtimeData();
                    window.lastVoiceUpdate = now;
                }
                
                // å¦‚æœWebSocketè¿æ¥å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
                if (!socket || !socket.connected) {
                    console.log('ğŸ”„ WebSocketæœªè¿æ¥ï¼Œä½¿ç”¨HTTPè½®è¯¢...');
                }
            }
        }, updateInterval);
        
        console.log('âœ… ç»Ÿä¸€è®¾ç½®å·²åº”ç”¨:', settings);
    }
    
    // åº”ç”¨åŠŸèƒ½å¼€å…³è®¾ç½®ï¼ˆç®€åŒ–ç‰ˆ - è¡¨æƒ…/åŠ¨ä½œ/è¯­éŸ³æ£€æµ‹é»˜è®¤æ˜¾ç¤ºï¼‰
    function applyFeatureToggles(settings) {
        // é¢è¯•å®˜é—®é¢˜æ˜¾ç¤º - å§‹ç»ˆæ˜¾ç¤ºé—®é¢˜
        const questionElement = document.getElementById('current-question');
        if (questionElement) {
            questionElement.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤ºé—®é¢˜
        }
        
        // è¡¨æƒ…æ£€æµ‹é¢æ¿ - é»˜è®¤æ˜¾ç¤º
        const expressionPanel = document.querySelector('.bg-white.rounded-lg.shadow-sm.p-6.mb-6');
        if (expressionPanel && expressionPanel.textContent.includes('è¡¨æƒ…æ£€æµ‹')) {
            expressionPanel.style.display = 'block';
        }
        
        // åŠ¨ä½œæ£€æµ‹é¢æ¿ - é»˜è®¤æ˜¾ç¤º
        const motionPanels = document.querySelectorAll('.bg-white.rounded-lg.shadow-sm.p-6.mb-6');
        motionPanels.forEach(panel => {
            if (panel.textContent.includes('åŠ¨ä½œæ£€æµ‹')) {
                panel.style.display = 'block';
            }
        });
        
        // è¯­éŸ³æƒ…æ„Ÿåˆ†æé¢æ¿ - é»˜è®¤æ˜¾ç¤º
        const voicePanels = document.querySelectorAll('.bg-white.rounded-lg.shadow-sm.p-6');
        voicePanels.forEach(panel => {
            if (panel.textContent.includes('è¯­éŸ³æƒ…æ„Ÿåˆ†æ')) {
                panel.style.display = 'block';
            }
        });
        
        // å®æ—¶æç¤ºåŠŸèƒ½
        if (!settings.realtimeTips) {
            // éšè—æç¤ºå…ƒç´ 
            const tipsElements = document.querySelectorAll('[data-tips]');
            tipsElements.forEach(el => el.style.display = 'none');
        }
        
        console.log('âœ… åŠŸèƒ½å¼€å…³å·²åº”ç”¨ï¼ˆè¡¨æƒ…/åŠ¨ä½œ/è¯­éŸ³æ£€æµ‹é»˜è®¤æ˜¾ç¤ºï¼‰');
    }
    
    // åŠ è½½è®¾ç½®
    function loadSettings() {
        const savedSettings = localStorage.getItem('interviewSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            applySettings(settings);
            return settings;
        }
        
        // é»˜è®¤è®¾ç½®
        const defaultSettings = {
            // FPSè®¾ç½®
            expressionFps: 1,
            motionFps: 1,
            voiceFps: 5,
            
            // åŠŸèƒ½å¼€å…³è®¾ç½® - é—®é¢˜æ˜¾ç¤ºå§‹ç»ˆä¸ºtrue
            questionDisplay: true, // å¼ºåˆ¶è®¾ç½®ä¸ºtrue
            expressionDetection: true,
            motionDetection: true,
            voiceAnalysis: true,
            realtimeTips: true,
            
            // æ˜¾ç¤ºè®¾ç½®
            showAllActions: true,
            autoStartAnalysis: true,
            enableWebSocket: true
        };
        
        applySettings(defaultSettings);
        return defaultSettings;
    }
    
    // å¯åŠ¨åˆå§‹åŒ–
    init();
    
    // åŠ è½½è®¾ç½®
    loadSettings();
    
    // å¼ºåˆ¶æ˜¾ç¤ºé—®é¢˜å…ƒç´ ï¼ˆé¢å¤–ä¿éšœï¼‰
    setTimeout(() => {
        const questionElement = document.getElementById('current-question');
        if (questionElement) {
            questionElement.style.display = 'block';
            console.log('âœ… å¼ºåˆ¶æ˜¾ç¤ºé—®é¢˜å…ƒç´ ');
        }
    }, 100);
    
    // ç»‘å®šè®¾ç½®æŒ‰é’®ï¼ˆé¡¶éƒ¨å’Œåº•éƒ¨ï¼‰
    try {
        const topSettingsBtn = document.getElementById('settings-btn');
        const bottomSettingsBtn = document.getElementById('settings-btn-footer');
        
        if (topSettingsBtn) {
            topSettingsBtn.addEventListener('click', showSettingsDialog);
            console.log('âœ… é¡¶éƒ¨è®¾ç½®æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        } else {
            console.warn('âš ï¸ æœªæ‰¾åˆ°é¡¶éƒ¨è®¾ç½®æŒ‰é’®');
        }
        
        if (bottomSettingsBtn) {
            bottomSettingsBtn.addEventListener('click', showSettingsDialog);
            console.log('âœ… åº•éƒ¨è®¾ç½®æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        } else {
            console.warn('âš ï¸ æœªæ‰¾åˆ°åº•éƒ¨è®¾ç½®æŒ‰é’®');
        }
    } catch (error) {
        console.error('âŒ ç»‘å®šè®¾ç½®æŒ‰é’®äº‹ä»¶æ—¶å‡ºé”™:', error);
    }
    
    // ç»“æŸé¢è¯•è·³è½¬
    const endBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent && btn.textContent.includes('ç»“æŸé¢è¯•'));
    if (endBtn) {
        endBtn.addEventListener('click', function() {
            window.location.href = './interview_report.html';
        });
    }
});
</script>

<!-- é¢˜ç›®è®¾ç½®æ¨¡æ€æ¡† -->
<div id="question-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">é€‰æ‹©é¢è¯•é¢˜ç›®</h3>
            <button id="close-question-modal" class="text-gray-400 hover:text-gray-600">
                <i class="ri-close-line ri-lg"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æŠ€æœ¯é¢†åŸŸ</label>
                <select id="tech-field-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">è¯·é€‰æ‹©æŠ€æœ¯é¢†åŸŸ</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å²—ä½ç±»å‹</label>
                <select id="position-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">è¯·é€‰æ‹©å²—ä½ç±»å‹</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é¢˜ç›®åºå·</label>
                <select id="question-id-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">è¯·é€‰æ‹©é¢˜ç›®</option>
                </select>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
            <button id="cancel-question-modal" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                å–æ¶ˆ
            </button>
            <button id="apply-question-modal" class="px-4 py-2 text-white bg-primary rounded-lg hover:bg-opacity-90 transition-colors">
                åº”ç”¨
            </button>
        </div>
    </div>
</div>

<script>
// é¢˜ç›®ç®¡ç†ç³»ç»Ÿ
class QuestionManager {
    constructor() {
        console.log('ğŸš€ åˆå§‹åŒ–QuestionManager...');
        
        // ä»URLå‚æ•°è·å–åˆå§‹å€¼
        const urlParams = this.getUrlParams();
        console.log('URLå‚æ•°:', urlParams);
        
        this.currentTechField = urlParams.techField || 'äººå·¥æ™ºèƒ½';
        this.currentPosition = urlParams.position || 'æŠ€æœ¯å²—';
        this.currentQuestionId = urlParams.questionId || 1;
        this.currentQuestions = [];
        
        console.log(`ğŸ“‹ åˆå§‹è®¾ç½®: ${this.currentTechField} - ${this.currentPosition} - é¢˜ç›®${this.currentQuestionId}`);
        
        this.init();
    }
    
    getUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            techField: urlParams.get('tech_field'),
            position: urlParams.get('position'),
            questionId: parseInt(urlParams.get('question_id')) || 1
        };
    }
    
    updateUrl() {
        const url = new URL(window.location);
        url.searchParams.set('tech_field', this.currentTechField);
        url.searchParams.set('position', this.currentPosition);
        url.searchParams.set('question_id', this.currentQuestionId);
        window.history.replaceState({}, '', url);
    }
    
    async init() {
        try {
            // è·å–é—®é¢˜åˆ†ç±»
            await this.loadCategories();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            this.setupEventListeners();
            
            // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæœ‰å‚æ•°åˆ™ç›´æ¥åŠ è½½å¯¹åº”é—®é¢˜
            const urlParams = this.getUrlParams();
            console.log('ğŸ” æ£€æŸ¥URLå‚æ•°:', urlParams);
            
            if (urlParams.techField && urlParams.position) {
                console.log(`ğŸ“‹ æ ¹æ®URLå‚æ•°åŠ è½½é—®é¢˜: ${urlParams.techField} - ${urlParams.position} - é¢˜ç›®${urlParams.questionId}`);
                // æ›´æ–°å½“å‰è®¾ç½®
                this.currentTechField = urlParams.techField;
                this.currentPosition = urlParams.position;
                this.currentQuestionId = urlParams.questionId || 1;
                
                // ç›´æ¥åŠ è½½å¯¹åº”çš„é—®é¢˜
                await this.loadQuestions(this.currentTechField, this.currentPosition);
                
                // å¦‚æœæŒ‡å®šäº†ç‰¹å®šé—®é¢˜IDï¼Œç¡®ä¿æ˜¾ç¤ºè¯¥é—®é¢˜
                if (urlParams.questionId) {
                    console.log(`ğŸ¯ æ˜¾ç¤ºæŒ‡å®šé—®é¢˜ID: ${urlParams.questionId}`);
                    this.currentQuestionId = urlParams.questionId;
                    this.displayCurrentQuestion();
                }
            } else {
                console.log('ğŸ“‹ æ²¡æœ‰URLå‚æ•°ï¼Œæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯');
                this.showWelcomeMessage();
            }
            
        } catch (error) {
            console.error('åˆå§‹åŒ–é¢˜ç›®ç®¡ç†å™¨å¤±è´¥:', error);
            // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œæ˜¾ç¤ºfallbacké—®é¢˜
            this.showFallbackQuestion();
        }
    }
    
    showFallbackQuestion() {
        console.log('ğŸ“‹ æ˜¾ç¤ºé»˜è®¤é—®é¢˜...');
        
        const questionElement = document.getElementById('current-question');
        const metaElement = document.getElementById('question-meta');
        
        if (questionElement) {
            // å¼ºåˆ¶æ˜¾ç¤ºé—®é¢˜å…ƒç´ 
            questionElement.style.display = 'block';
            questionElement.innerHTML = 
                `è¯·è¯¦ç»†ä»‹ç»ä¸€ä¸‹æ‚¨çš„æŠ€æœ¯èƒŒæ™¯å’Œé¡¹ç›®ç»éªŒã€‚åŒ…æ‹¬æ‚¨æœ€ç†Ÿæ‚‰çš„æŠ€æœ¯æ ˆã€å‚ä¸è¿‡çš„é‡è¦é¡¹ç›®ï¼Œä»¥åŠåœ¨é¡¹ç›®ä¸­é‡åˆ°çš„æŠ€æœ¯æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆã€‚è¯·é‡ç‚¹è¯´æ˜æ‚¨åœ¨å›¢é˜Ÿä¸­çš„è§’è‰²å’Œè´¡çŒ®ã€‚`;
        }
        
        if (metaElement) {
            metaElement.textContent = 'æŠ€æœ¯èƒŒæ™¯ä¸é¡¹ç›®ç»éªŒ | é»˜è®¤é—®é¢˜';
        }
        
        // æ˜¾ç¤ºä¸‹ä¸€é“é¢˜æŒ‰é’®
        const nextBtn = document.getElementById('next-question-btn');
        if (nextBtn) {
            nextBtn.style.display = 'flex';
        }
        
        console.log('âœ… é»˜è®¤é—®é¢˜æ˜¾ç¤ºå®Œæˆ');
    }
    
    loadFallbackQuestions(techField, position) {
        console.log(`ğŸ“‹ åŠ è½½fallbacké—®é¢˜: ${techField} - ${position}`);
        
        // æ ¹æ®techFieldå’Œpositionæä¾›ä¸€äº›é»˜è®¤é—®é¢˜
        const fallbackQuestions = {
            'äººå·¥æ™ºèƒ½': {
                'æŠ€æœ¯å²—': [
                    {
                        id: 1,
                        question: "è¯·è¯¦ç»†è§£é‡Šä¸€ä¸‹æ·±åº¦å­¦ä¹ ä¸­çš„åå‘ä¼ æ’­ç®—æ³•çš„åŸç†ï¼Œä»¥åŠå®ƒåœ¨ç¥ç»ç½‘ç»œè®­ç»ƒä¸­çš„ä½œç”¨ã€‚",
                        answer: "åå‘ä¼ æ’­ç®—æ³•æ˜¯æ·±åº¦å­¦ä¹ ä¸­çš„æ ¸å¿ƒç®—æ³•ï¼ŒåŸºäºé“¾å¼æ³•åˆ™è®¡ç®—æŸå¤±å‡½æ•°ç›¸å¯¹äºç½‘ç»œå‚æ•°çš„æ¢¯åº¦..."
                    },
                    {
                        id: 2,
                        question: "ä»€ä¹ˆæ˜¯è¿‡æ‹Ÿåˆï¼Ÿå¦‚ä½•æ£€æµ‹å’Œé˜²æ­¢è¿‡æ‹Ÿåˆï¼Ÿè¯·ä¸¾ä¾‹è¯´æ˜å‡ ç§å¸¸ç”¨çš„æ­£åˆ™åŒ–æ–¹æ³•ã€‚",
                        answer: "è¿‡æ‹Ÿåˆæ˜¯æŒ‡æ¨¡å‹åœ¨è®­ç»ƒé›†ä¸Šè¡¨ç°å¾ˆå¥½ï¼Œä½†åœ¨æµ‹è¯•é›†ä¸Šè¡¨ç°è¾ƒå·®çš„ç°è±¡..."
                    },
                    {
                        id: 3,
                        question: "è§£é‡Šå·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰çš„åŸºæœ¬ç»“æ„å’Œå·¥ä½œåŸç†ï¼Œä¸ºä»€ä¹ˆCNNç‰¹åˆ«é€‚åˆå¤„ç†å›¾åƒä»»åŠ¡ï¼Ÿ",
                        answer: "CNNåŒ…å«å·ç§¯å±‚ã€æ± åŒ–å±‚å’Œå…¨è¿æ¥å±‚..."
                    }
                ],
                'äº§å“å²—': [
                    {
                        id: 1,
                        question: "ä½ å¦‚ä½•ä¸ºä¸€æ¬¾AIäº§å“å®šä¹‰æ ¸å¿ƒä»·å€¼å’Œç›®æ ‡ç”¨æˆ·ï¼Ÿè¯·ä¸¾ä¾‹è¯´æ˜ã€‚",
                        answer: "é¦–å…ˆé€šè¿‡å¸‚åœºè°ƒç ”å’Œç”¨æˆ·ç ”ç©¶ï¼Œè¯†åˆ«å‡ºç”¨æˆ·çš„æ ¸å¿ƒç—›ç‚¹..."
                    }
                ]
            },
            'é»˜è®¤': [
                {
                    id: 1,
                    question: "è¯·è¯¦ç»†ä»‹ç»ä¸€ä¸‹æ‚¨çš„æŠ€æœ¯èƒŒæ™¯å’Œé¡¹ç›®ç»éªŒã€‚åŒ…æ‹¬æ‚¨æœ€ç†Ÿæ‚‰çš„æŠ€æœ¯æ ˆã€å‚ä¸è¿‡çš„é‡è¦é¡¹ç›®ï¼Œä»¥åŠåœ¨é¡¹ç›®ä¸­é‡åˆ°çš„æŠ€æœ¯æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆã€‚",
                    answer: "è¿™æ˜¯ä¸€ä¸ªå¼€æ”¾æ€§é—®é¢˜ï¼Œä¸»è¦è€ƒå¯Ÿå€™é€‰äººçš„æŠ€æœ¯èƒŒæ™¯å’Œé¡¹ç›®ç»éªŒã€‚"
                },
                {
                    id: 2,
                    question: "æè¿°ä¸€ä¸‹æ‚¨åœ¨å›¢é˜Ÿåä½œä¸­çš„è§’è‰²å’Œè´¡çŒ®ï¼Œä»¥åŠå¦‚ä½•å¤„ç†å›¢é˜Ÿä¸­çš„æŠ€æœ¯åˆ†æ­§å’Œå†²çªã€‚",
                    answer: "è¿™ä¸ªé—®é¢˜è€ƒå¯Ÿå€™é€‰äººçš„å›¢é˜Ÿåä½œèƒ½åŠ›å’Œæ²Ÿé€šæŠ€å·§ã€‚"
                }
            ]
        };
        
        // å°è¯•è·å–å¯¹åº”çš„é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é—®é¢˜
        let questions = null;
        if (fallbackQuestions[techField] && fallbackQuestions[techField][position]) {
            questions = fallbackQuestions[techField][position];
        } else {
            questions = fallbackQuestions['é»˜è®¤'];
        }
        
        this.currentQuestions = questions;
        this.currentTechField = techField;
        this.currentPosition = position;
        
        console.log(`âœ… åŠ è½½fallbacké—®é¢˜æˆåŠŸ: ${this.currentQuestions.length} ä¸ªé—®é¢˜`);
        
        // æ˜¾ç¤ºç¬¬ä¸€ä¸ªé—®é¢˜
        this.displayCurrentQuestion();
    }
    
    showWelcomeMessage() {
        console.log('ğŸ‰ æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯...');
        
        const questionElement = document.getElementById('current-question');
        const metaElement = document.getElementById('question-meta');
        
        if (questionElement) {
            // å¼ºåˆ¶æ˜¾ç¤ºé—®é¢˜å…ƒç´ 
            questionElement.style.display = 'block';
            questionElement.innerHTML = 
                `æ‚¨å¥½ï¼æˆ‘æ˜¯ææ•™æˆï¼Œæ‚¨çš„AIé¢è¯•å®˜ã€‚æ¬¢è¿å‚åŠ æˆ‘ä»¬çš„æ™ºèƒ½é¢è¯•ç³»ç»Ÿï¼ğŸ‰<br><br>
                
                åœ¨å¼€å§‹æ­£å¼é¢è¯•ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆäº†è§£ä¸€ä¸‹æ‚¨çš„åŸºæœ¬æƒ…å†µã€‚è¯·æ‚¨ç”¨30ç§’æ—¶é—´ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±ï¼ŒåŒ…æ‹¬æ‚¨çš„æ•™è‚²èƒŒæ™¯ã€æŠ€æœ¯æ ˆä»¥åŠæ‚¨æœ€æ„Ÿå…´è¶£çš„æŠ€æœ¯é¢†åŸŸã€‚è¿™æ ·æˆ‘å°±èƒ½ä¸ºæ‚¨å‡†å¤‡æ›´åˆé€‚çš„é¢è¯•é¢˜ç›®ã€‚<br><br>
                
                è¯·ç¡®ä¿æ‚¨çš„æ‘„åƒå¤´å’Œéº¦å…‹é£å·²å¼€å¯ï¼Œæˆ‘ä¼šå®æ—¶åˆ†ææ‚¨çš„è¡¨æƒ…ã€è‚¢ä½“è¯­è¨€å’Œè¯­éŸ³æƒ…æ„Ÿï¼Œä¸ºæ‚¨æä¾›å…¨é¢çš„é¢è¯•åé¦ˆã€‚<br><br>
                
                å‡†å¤‡å¥½äº†å—ï¼Ÿè¯·å¼€å§‹æ‚¨çš„è‡ªæˆ‘ä»‹ç»ï¼`;
        }
        
        if (metaElement) {
            metaElement.textContent = 'æ¬¢è¿æ¥åˆ°æ™ºèƒ½é¢è¯•ç³»ç»Ÿ';
        }
        
        // éšè—ä¸‹ä¸€é“é¢˜æŒ‰é’®ï¼Œæ˜¾ç¤ºå¼€å§‹é¢è¯•æŒ‰é’®
        const nextBtn = document.getElementById('next-question-btn');
        if (nextBtn) {
            nextBtn.style.display = 'none';
            console.log('âœ… éšè—ä¸‹ä¸€é“é¢˜æŒ‰é’®');
        }
        
        // æ·»åŠ å¼€å§‹é¢è¯•æŒ‰é’®
        this.addStartInterviewButton();
        
        console.log('âœ… æ¬¢è¿ä¿¡æ¯æ˜¾ç¤ºå®Œæˆ');
    }
    
    addStartInterviewButton() {
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¼€å§‹é¢è¯•æŒ‰é’®
        let startBtn = document.getElementById('start-interview-btn');
        if (!startBtn) {
            startBtn = document.createElement('button');
            startBtn.id = 'start-interview-btn';
            startBtn.className = 'bg-green-500 text-white px-4 py-2 rounded-button flex items-center hover:bg-opacity-90 transition-colors whitespace-nowrap';
            startBtn.innerHTML = '<i class="ri-play-line mr-1"></i><span>å¼€å§‹æ­£å¼é¢è¯•</span>';
            
            // æ’å…¥åˆ°ä¸‹ä¸€é“é¢˜æŒ‰é’®çš„ä½ç½®
            const nextBtn = document.getElementById('next-question-btn');
            if (nextBtn && nextBtn.parentNode) {
                nextBtn.parentNode.insertBefore(startBtn, nextBtn);
            }
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            startBtn.addEventListener('click', () => {
                this.startFormalInterview();
            });
            
            console.log('âœ… å¼€å§‹é¢è¯•æŒ‰é’®å·²æ·»åŠ ');
        }
    }
    
    async startFormalInterview() {
        console.log('ğŸ¬ å¼€å§‹æ­£å¼é¢è¯•...');
        
        // ç§»é™¤å¼€å§‹é¢è¯•æŒ‰é’®
        const startBtn = document.getElementById('start-interview-btn');
        if (startBtn) {
            startBtn.remove();
        }
        
        // æ˜¾ç¤ºä¸‹ä¸€é“é¢˜æŒ‰é’®
        const nextBtn = document.getElementById('next-question-btn');
        if (nextBtn) {
            nextBtn.style.display = 'flex';
        }
        
        // åŠ è½½é—®é¢˜ - ä¼˜å…ˆä½¿ç”¨APIï¼Œå¤±è´¥åˆ™ä½¿ç”¨fallback
        try {
            await this.loadQuestions(this.currentTechField, this.currentPosition);
        } catch (error) {
            console.warn('âš ï¸ APIåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨fallbacké—®é¢˜');
            this.loadFallbackQuestions(this.currentTechField, this.currentPosition);
        }
        
        console.log('âœ… æ­£å¼é¢è¯•å·²å¼€å§‹');
    }
    
    async loadCategories() {
        try {
            console.log('ğŸ“‹ ä»åç«¯APIåŠ è½½é—®é¢˜åˆ†ç±»...');
            const response = await fetch('/api/v1/questions/categories');
            const data = await response.json();
            
            console.log('ğŸ“Š APIå“åº”æ•°æ®:', data);
            
            if (data.status === 'success') {
                this.populateSelects(data.categories);
                console.log('âœ… é—®é¢˜åˆ†ç±»åŠ è½½æˆåŠŸ');
            } else {
                console.error('âŒ åŠ è½½é—®é¢˜åˆ†ç±»å¤±è´¥:', data.message);
                console.log('ğŸ”„ ä½¿ç”¨fallbackåˆ†ç±»æ•°æ®');
                this.loadFallbackCategories();
            }
        } catch (error) {
            console.error('âŒ è¯·æ±‚é—®é¢˜åˆ†ç±»å¤±è´¥:', error);
            console.log('ğŸ”„ ä½¿ç”¨fallbackåˆ†ç±»æ•°æ®');
            this.loadFallbackCategories();
        }
    }
    
    convertToCategories(questionsData) {
        const categories = [];
        
        Object.keys(questionsData).forEach(techField => {
            Object.keys(questionsData[techField]).forEach(position => {
                const questions = questionsData[techField][position];
                categories.push({
                    tech_field: techField,
                    position: position,
                    question_count: questions.length
                });
            });
        });
        
        console.log('ğŸ“‹ è½¬æ¢åçš„åˆ†ç±»:', categories);
        return categories;
    }
    
    loadFallbackCategories() {
        const fallbackCategories = [
            { tech_field: 'äººå·¥æ™ºèƒ½', position: 'æŠ€æœ¯å²—', question_count: 3 },
            { tech_field: 'äººå·¥æ™ºèƒ½', position: 'äº§å“å²—', question_count: 3 },
            { tech_field: 'äººå·¥æ™ºèƒ½', position: 'è¿è¥å²—', question_count: 3 },
            { tech_field: 'å¤§æ•°æ®', position: 'æŠ€æœ¯å²—', question_count: 3 },
            { tech_field: 'ç‰©è”ç½‘', position: 'æŠ€æœ¯å²—', question_count: 3 }
        ];
        
        this.populateSelects(fallbackCategories);
        console.log('âœ… Fallbackåˆ†ç±»æ•°æ®å·²åŠ è½½');
    }
    
    populateSelects(categories) {
        const techFieldSelect = document.getElementById('tech-field-select');
        const positionSelect = document.getElementById('position-select');
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        techFieldSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æŠ€æœ¯é¢†åŸŸ</option>';
        positionSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å²—ä½ç±»å‹</option>';
        
        // è·å–å”¯ä¸€çš„æŠ€æœ¯é¢†åŸŸ
        const techFields = [...new Set(categories.map(cat => cat.tech_field))];
        techFields.forEach(field => {
            const option = document.createElement('option');
            option.value = field;
            option.textContent = field;
            if (field === this.currentTechField) {
                option.selected = true;
            }
            techFieldSelect.appendChild(option);
        });
        
        // æ ¹æ®å½“å‰æŠ€æœ¯é¢†åŸŸå¡«å……å²—ä½
        this.updatePositionOptions(categories);
    }
    
    updatePositionOptions(categories) {
        const positionSelect = document.getElementById('position-select');
        const currentFieldCategories = categories.filter(cat => cat.tech_field === this.currentTechField);
        
        positionSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å²—ä½ç±»å‹</option>';
        
        currentFieldCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.position;
            option.textContent = `${cat.position} (${cat.question_count}é¢˜)`;
            if (cat.position === this.currentPosition) {
                option.selected = true;
            }
            positionSelect.appendChild(option);
        });
    }
    
    async loadQuestions(techField, position) {
        try {
            console.log(`ğŸ”„ ä»åç«¯APIåŠ è½½é—®é¢˜: ${techField} - ${position}`);
            
            const response = await fetch(`/api/v1/questions/${encodeURIComponent(techField)}/${encodeURIComponent(position)}`);
            const data = await response.json();
            
            console.log('APIå“åº”:', data);
            
            if (data.status === 'success') {
                this.currentQuestions = data.questions;
                this.currentTechField = techField;
                this.currentPosition = position;
                console.log(`âœ… ä»APIåŠ è½½åˆ° ${this.currentQuestions.length} ä¸ªé—®é¢˜`);
                
                // ç¡®ä¿currentQuestionIdæœ‰æ•ˆ
                if (!this.currentQuestionId || !this.currentQuestions.find(q => q.id === this.currentQuestionId)) {
                    this.currentQuestionId = this.currentQuestions.length > 0 ? this.currentQuestions[0].id : 1;
                    console.log(`ğŸ“‹ è®¾ç½®å½“å‰é—®é¢˜IDä¸º: ${this.currentQuestionId}`);
                }
                
                this.updateQuestionOptions();
                this.displayCurrentQuestion();
            } else {
                console.error('âŒ åŠ è½½é—®é¢˜å¤±è´¥:', data.message);
                // ä½¿ç”¨fallbacké—®é¢˜
                this.loadFallbackQuestions(techField, position);
            }
        } catch (error) {
            console.error('âŒ è¯·æ±‚é—®é¢˜å¤±è´¥:', error);
            // ä½¿ç”¨fallbacké—®é¢˜
            this.loadFallbackQuestions(techField, position);
        }
    }
    
    showErrorMessage(message) {
        const questionElement = document.getElementById('current-question');
        const metaElement = document.getElementById('question-meta');
        
        if (questionElement) {
            questionElement.innerHTML = `<span class="text-red-600">âŒ åŠ è½½é—®é¢˜å¤±è´¥: ${message}</span>`;
        }
        
        if (metaElement) {
            metaElement.textContent = 'åŠ è½½å¤±è´¥';
        }
    }
    
    updateQuestionOptions() {
        const questionSelect = document.getElementById('question-id-select');
        questionSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é¢˜ç›®</option>';
        
        this.currentQuestions.forEach(question => {
            const option = document.createElement('option');
            option.value = question.id;
            option.textContent = `ç¬¬${question.id}é¢˜`;
            if (question.id === this.currentQuestionId) {
                option.selected = true;
            }
            questionSelect.appendChild(option);
        });
    }
    
    displayCurrentQuestion() {
        console.log(`ğŸ“‹ æ˜¾ç¤ºé—®é¢˜ ID: ${this.currentQuestionId}`);
        console.log(`ğŸ“‹ å¯ç”¨é—®é¢˜æ•°é‡: ${this.currentQuestions ? this.currentQuestions.length : 0}`);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é—®é¢˜æ•°æ®
        if (!this.currentQuestions || this.currentQuestions.length === 0) {
            console.warn('âš ï¸ æ²¡æœ‰å¯ç”¨çš„é—®é¢˜ï¼Œä½¿ç”¨fallbacké—®é¢˜');
            this.loadFallbackQuestions(this.currentTechField || 'äººå·¥æ™ºèƒ½', this.currentPosition || 'æŠ€æœ¯å²—');
            return;
        }
        
        const currentQuestion = this.currentQuestions.find(q => q.id === this.currentQuestionId);
        if (currentQuestion) {
            const questionElement = document.getElementById('current-question');
            const metaElement = document.getElementById('question-meta');
            
            if (questionElement) {
                // å¼ºåˆ¶æ˜¾ç¤ºé—®é¢˜å…ƒç´ 
                questionElement.style.display = 'block';
                // ä½¿ç”¨innerHTMLä»¥æ”¯æŒæ ¼å¼åŒ–æ–‡æœ¬
                questionElement.innerHTML = currentQuestion.question;
                console.log('âœ… é—®é¢˜å†…å®¹å·²è®¾ç½®');
            } else {
                console.error('âŒ æœªæ‰¾åˆ°é—®é¢˜æ˜¾ç¤ºå…ƒç´  #current-question');
            }
            
            if (metaElement) {
                metaElement.textContent = 
                    `${this.currentTechField} - ${this.currentPosition} | é¢˜ç›® ${this.currentQuestionId}/${this.currentQuestions.length}`;
                console.log('âœ… é—®é¢˜å…ƒæ•°æ®å·²è®¾ç½®');
            } else {
                console.error('âŒ æœªæ‰¾åˆ°é—®é¢˜å…ƒæ•°æ®å…ƒç´  #question-meta');
            }
            
            // æ˜¾ç¤ºä¸‹ä¸€é“é¢˜æŒ‰é’®
            const nextBtn = document.getElementById('next-question-btn');
            if (nextBtn) {
                nextBtn.style.display = 'flex';
                console.log('âœ… ä¸‹ä¸€é¢˜æŒ‰é’®å·²æ˜¾ç¤º');
            }
            
            // æ›´æ–°URLå‚æ•°
            this.updateUrl();
            
            console.log('âœ… æ˜¾ç¤ºé—®é¢˜æˆåŠŸ:', currentQuestion.question.substring(0, 50) + '...');
        } else {
            console.warn(`âš ï¸ æœªæ‰¾åˆ°é—®é¢˜ ID ${this.currentQuestionId}ï¼Œå°è¯•æ˜¾ç¤ºç¬¬ä¸€ä¸ªé—®é¢˜`);
            if (this.currentQuestions.length > 0) {
                this.currentQuestionId = this.currentQuestions[0].id;
                this.displayCurrentQuestion();
            }
        }
    }
    
    async nextQuestion() {
        const nextId = this.currentQuestionId + 1;
        const maxId = Math.max(...this.currentQuestions.map(q => q.id));
        
        if (nextId <= maxId) {
            this.currentQuestionId = nextId;
            this.displayCurrentQuestion();
        } else {
            // å¦‚æœå·²æ˜¯æœ€åä¸€é¢˜ï¼Œå¯ä»¥é€‰æ‹©å¾ªç¯åˆ°ç¬¬ä¸€é¢˜æˆ–éšæœºè·å–é¢˜ç›®
            const shouldGetRandom = confirm('å·²åˆ°æœ€åä¸€é¢˜ï¼Œæ˜¯å¦è·å–éšæœºé¢˜ç›®ï¼Ÿ');
            if (shouldGetRandom) {
                await this.getRandomQuestion();
            } else {
                this.currentQuestionId = 1;
                this.displayCurrentQuestion();
            }
        }
    }
    
    async getRandomQuestion() {
        try {
            console.log('ğŸ² ä»åç«¯APIè·å–éšæœºé—®é¢˜...');
            
            const response = await fetch('/api/v1/questions/random');
            const data = await response.json();
            
            if (data.status === 'success') {
                this.currentTechField = data.tech_field;
                this.currentPosition = data.position;
                this.currentQuestionId = data.question.id;
                
                console.log(`ğŸ² éšæœºé€‰æ‹©: ${this.currentTechField} - ${this.currentPosition} - é¢˜ç›®${this.currentQuestionId}`);
                
                // é‡æ–°åŠ è½½è¯¥åˆ†ç±»çš„æ‰€æœ‰é—®é¢˜
                await this.loadQuestions(this.currentTechField, this.currentPosition);
            } else {
                console.error('è·å–éšæœºé—®é¢˜å¤±è´¥:', data.message);
                this.getRandomFallbackQuestion();
            }
        } catch (error) {
            console.error('âŒ è¯·æ±‚éšæœºé—®é¢˜å¤±è´¥:', error);
            // ä½¿ç”¨fallbackéšæœºé—®é¢˜
            this.getRandomFallbackQuestion();
        }
    }
    
    getRandomFallbackQuestion() {
        const fallbackOptions = [
            { techField: 'äººå·¥æ™ºèƒ½', position: 'æŠ€æœ¯å²—' },
            { techField: 'äººå·¥æ™ºèƒ½', position: 'äº§å“å²—' },
            { techField: 'å¤§æ•°æ®', position: 'æŠ€æœ¯å²—' },
            { techField: 'ç‰©è”ç½‘', position: 'æŠ€æœ¯å²—' }
        ];
        
        const randomOption = fallbackOptions[Math.floor(Math.random() * fallbackOptions.length)];
        console.log(`ğŸ² Fallbackéšæœºé€‰æ‹©: ${randomOption.techField} - ${randomOption.position}`);
        
        this.currentTechField = randomOption.techField;
        this.currentPosition = randomOption.position;
        this.currentQuestionId = 1;
        
        this.loadFallbackQuestions(this.currentTechField, this.currentPosition);
    }
    
    setupEventListeners() {
        // ä¸‹ä¸€é“é¢˜æŒ‰é’®
        document.getElementById('next-question-btn').addEventListener('click', () => {
            this.nextQuestion();
        });
        
        // é¢˜ç›®è®¾ç½®æŒ‰é’®
        document.getElementById('question-settings-btn').addEventListener('click', () => {
            document.getElementById('question-modal').classList.remove('hidden');
        });
        
        // å…³é—­æ¨¡æ€æ¡†
        document.getElementById('close-question-modal').addEventListener('click', () => {
            document.getElementById('question-modal').classList.add('hidden');
        });
        
        document.getElementById('cancel-question-modal').addEventListener('click', () => {
            document.getElementById('question-modal').classList.add('hidden');
        });
        
        // æŠ€æœ¯é¢†åŸŸå˜åŒ–
        document.getElementById('tech-field-select').addEventListener('change', async (e) => {
            this.currentTechField = e.target.value;
            if (this.currentTechField) {
                this.currentQuestionId = 1; // é‡ç½®ä¸ºç¬¬ä¸€é¢˜
                // é‡æ–°åŠ è½½åˆ†ç±»ä»¥æ›´æ–°å²—ä½é€‰é¡¹
                await this.loadCategories();
            }
        });
        
        // å²—ä½å˜åŒ–
        document.getElementById('position-select').addEventListener('change', async (e) => {
            this.currentPosition = e.target.value;
            if (this.currentTechField && this.currentPosition) {
                this.currentQuestionId = 1; // é‡ç½®ä¸ºç¬¬ä¸€é¢˜
                await this.loadQuestions(this.currentTechField, this.currentPosition);
            }
        });
        
        // åº”ç”¨é¢˜ç›®è®¾ç½®
        document.getElementById('apply-question-modal').addEventListener('click', () => {
            const questionId = parseInt(document.getElementById('question-id-select').value);
            if (questionId) {
                this.currentQuestionId = questionId;
                this.displayCurrentQuestion();
                document.getElementById('question-modal').classList.add('hidden');
            }
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('question-modal').addEventListener('click', (e) => {
            if (e.target.id === 'question-modal') {
                document.getElementById('question-modal').classList.add('hidden');
            }
        });
    }
}

// åˆå§‹åŒ–é¢˜ç›®ç®¡ç†å™¨
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“„ DOMå·²åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–QuestionManager...');
    
    // åˆå§‹åŒ–è®¡æ—¶å™¨
    let seconds = 0;
    let minutes = 0;
    const timerElement = document.getElementById('timer');
    
    if (timerElement) {
        function updateTimer() {
            seconds++;
            if (seconds >= 60) {
                seconds = 0;
                minutes++;
            }
            const formattedMinutes = minutes.toString().padStart(2, '0');
            const formattedSeconds = seconds.toString().padStart(2, '0');
            timerElement.textContent = `${formattedMinutes}:${formattedSeconds}`;
        }
        setInterval(updateTimer, 1000);
        console.log('âœ… è®¡æ—¶å™¨å·²åˆå§‹åŒ–');
    } else {
        console.warn('âš ï¸ æœªæ‰¾åˆ°è®¡æ—¶å™¨å…ƒç´  #timer');
    }
    
    // æ£€æŸ¥å¿…è¦å…ƒç´ æ˜¯å¦å­˜åœ¨
    const questionElement = document.getElementById('current-question');
    const metaElement = document.getElementById('question-meta');
    
    if (questionElement) {
        console.log('âœ… æ‰¾åˆ°é—®é¢˜å…ƒç´ :', questionElement);
    } else {
        console.error('âŒ æœªæ‰¾åˆ°é—®é¢˜å…ƒç´  #current-question');
    }
    
    if (metaElement) {
        console.log('âœ… æ‰¾åˆ°å…ƒæ•°æ®å…ƒç´ :', metaElement);
    } else {
        console.error('âŒ æœªæ‰¾åˆ°å…ƒæ•°æ®å…ƒç´  #question-meta');
    }
    
    // åˆå§‹åŒ–QuestionManager
    const questionManager = new QuestionManager();
    
    // å°†questionManageræš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸä»¥ä¾¿è°ƒè¯•
    window.questionManager = questionManager;
    
    // åˆå§‹åŒ–QuestionManager
    questionManager.init();
    
    // ç¡®ä¿é—®é¢˜èƒ½å¤Ÿæ­£ç¡®æ¸²æŸ“ - æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
    setTimeout(() => {
        // æ£€æŸ¥URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const techField = urlParams.get('tech_field') || 'äººå·¥æ™ºèƒ½';
        const position = urlParams.get('position') || 'æŠ€æœ¯å²—';
        const questionId = parseInt(urlParams.get('question_id')) || 1;
        
        console.log('ğŸ”„ é‡è¯•æœºåˆ¶æ£€æŸ¥URLå‚æ•°:', { techField, position, questionId });
        
        if (!questionManager.currentQuestions || questionManager.currentQuestions.length === 0) {
            console.log('ğŸ”„ é—®é¢˜æœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½...');
            
            // å¦‚æœæœ‰URLå‚æ•°ï¼Œä½¿ç”¨URLå‚æ•°çš„å€¼
            if (urlParams.get('tech_field') && urlParams.get('position')) {
                questionManager.currentTechField = techField;
                questionManager.currentPosition = position;
                questionManager.currentQuestionId = questionId;
                console.log(`ğŸ”„ ä½¿ç”¨URLå‚æ•°é‡æ–°åŠ è½½: ${techField} - ${position} - é¢˜ç›®${questionId}`);
            }
            
            questionManager.loadQuestions(questionManager.currentTechField, questionManager.currentPosition).then(() => {
                if (questionManager.currentQuestions && questionManager.currentQuestions.length > 0) {
                    console.log('âœ… é—®é¢˜é‡æ–°åŠ è½½æˆåŠŸï¼Œæ˜¾ç¤ºæŒ‡å®šé—®é¢˜');
                    questionManager.displayCurrentQuestion();
                } else {
                    console.warn('âš ï¸ é—®é¢˜åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤é—®é¢˜');
                    questionManager.showFallbackQuestion();
                }
            }).catch(error => {
                console.error('âŒ é—®é¢˜åŠ è½½å¤±è´¥:', error);
                questionManager.showFallbackQuestion();
            });
        } else if (urlParams.get('tech_field') && urlParams.get('position')) {
            // å¦‚æœé—®é¢˜å·²åŠ è½½ä½†URLå‚æ•°ä¸åŒ¹é…ï¼Œé‡æ–°åŠ è½½æ­£ç¡®çš„é—®é¢˜
            if (questionManager.currentTechField !== techField || 
                questionManager.currentPosition !== position ||
                questionManager.currentQuestionId !== questionId) {
                console.log('ğŸ”„ URLå‚æ•°ä¸åŒ¹é…ï¼Œé‡æ–°åŠ è½½æ­£ç¡®çš„é—®é¢˜');
                questionManager.currentTechField = techField;
                questionManager.currentPosition = position;
                questionManager.currentQuestionId = questionId;
                questionManager.loadQuestions(techField, position);
            }
        }
    }, 1000);
});

// æ·»åŠ ä¸´æ—¶æµ‹è¯•åŠŸèƒ½
window.testSettings = function() {
    console.log('ğŸ§ª æµ‹è¯•è®¾ç½®é¢æ¿...');
    showSettingsDialog();
};

window.testWelcome = function() {
    console.log('ğŸ§ª æµ‹è¯•æ¬¢è¿ä¿¡æ¯...');
    questionManager.showWelcomeMessage();
};

window.testLoadQuestions = function() {
    console.log('ğŸ§ª æµ‹è¯•åŠ è½½é—®é¢˜...');
    questionManager.loadQuestions('äººå·¥æ™ºèƒ½', 'æŠ€æœ¯å²—');
};

window.testDisplayQuestion = function() {
    console.log('ğŸ§ª æµ‹è¯•æ˜¾ç¤ºé—®é¢˜...');
    questionManager.displayCurrentQuestion();
};

window.forceShowQuestion = function() {
    console.log('ğŸ§ª å¼ºåˆ¶æ˜¾ç¤ºæµ‹è¯•é—®é¢˜...');
    const questionElement = document.getElementById('current-question');
    const metaElement = document.getElementById('question-meta');
    
    if (questionElement) {
        questionElement.innerHTML = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é—®é¢˜ï¼Œç”¨äºéªŒè¯é—®é¢˜æ˜¾ç¤ºåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚å¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™æ®µæ–‡å­—ï¼Œè¯´æ˜é—®é¢˜æ˜¾ç¤ºåŠŸèƒ½æ­£å¸¸ã€‚';
        questionElement.style.color = '#1f2937';
        questionElement.style.fontSize = '16px';
        questionElement.style.lineHeight = '1.6';
    }
    
    if (metaElement) {
        metaElement.textContent = 'æµ‹è¯•æ¨¡å¼ - é—®é¢˜æ˜¾ç¤ºéªŒè¯';
    }
    
    console.log('âœ… æµ‹è¯•é—®é¢˜å·²æ˜¾ç¤º');
};

window.loadSpecificQuestion = function(techField = 'äººå·¥æ™ºèƒ½', position = 'æŠ€æœ¯å²—', questionId = 1) {
    console.log(`ğŸ§ª åŠ è½½æŒ‡å®šé—®é¢˜: ${techField} - ${position} - é¢˜ç›®${questionId}`);
    
    if (window.questionManager) {
        window.questionManager.currentTechField = techField;
        window.questionManager.currentPosition = position;
        window.questionManager.currentQuestionId = questionId;
        
        window.questionManager.loadQuestions(techField, position).then(() => {
            console.log('âœ… æŒ‡å®šé—®é¢˜åŠ è½½å®Œæˆ');
            window.questionManager.displayCurrentQuestion();
        }).catch(error => {
            console.warn('âš ï¸ APIåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨fallbacké—®é¢˜');
            window.questionManager.loadFallbackQuestions(techField, position);
        });
    } else {
        console.log('âŒ questionManageræœªæ‰¾åˆ°');
    }
};

window.testApiLoading = function() {
    console.log('ğŸ§ª æµ‹è¯•åç«¯APIåŠ è½½...');
    
    // æµ‹è¯•åˆ†ç±»API
    fetch('/api/v1/questions/categories')
        .then(response => {
            console.log('ğŸ“¡ åˆ†ç±»API ResponseçŠ¶æ€:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('âœ… åˆ†ç±»APIåŠ è½½æˆåŠŸ');
            console.log('ğŸ“Š åˆ†ç±»æ•°æ®:', data);
            
            if (data.status === 'success' && data.categories) {
                console.log(`ğŸ“‹ æ€»åˆ†ç±»æ•°: ${data.categories.length}`);
                data.categories.forEach(cat => {
                    console.log(`- ${cat.tech_field} - ${cat.position}: ${cat.question_count}é¢˜`);
                });
            }
            
            // æµ‹è¯•ç‰¹å®šé—®é¢˜API
            return fetch('/api/v1/questions/äººå·¥æ™ºèƒ½/æŠ€æœ¯å²—');
        })
        .then(response => {
            console.log('ğŸ“¡ é—®é¢˜API ResponseçŠ¶æ€:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('âœ… é—®é¢˜APIåŠ è½½æˆåŠŸ');
            console.log('ğŸ“Š é—®é¢˜æ•°æ®:', data);
            
            if (data.status === 'success' && data.questions) {
                console.log(`ğŸ“‹ é—®é¢˜æ•°é‡: ${data.questions.length}`);
                if (data.questions[0]) {
                    console.log('ğŸ“‹ ç¤ºä¾‹é—®é¢˜:', data.questions[0].question.substring(0, 50) + '...');
                }
            }
        })
        .catch(error => {
            console.error('âŒ APIåŠ è½½å¤±è´¥:', error);
            console.log('ğŸ’¡ è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ');
        });
};

window.testApiDataIntegrity = function() {
    console.log('ğŸ§ª æµ‹è¯•APIæ•°æ®å®Œæ•´æ€§...');
    
    if (window.questionManager) {
        // æµ‹è¯•æ˜¯å¦èƒ½ä»APIåŠ è½½æ‰€æœ‰åˆ†ç±»
        window.questionManager.loadCategories().then(() => {
            console.log('âœ… APIåˆ†ç±»æ•°æ®åŠ è½½æµ‹è¯•å®Œæˆ');
            
            // æµ‹è¯•åŠ è½½ä¸åŒçš„æŠ€æœ¯é¢†åŸŸå’Œå²—ä½
            const testCases = [
                ['äººå·¥æ™ºèƒ½', 'æŠ€æœ¯å²—'],
                ['äººå·¥æ™ºèƒ½', 'äº§å“å²—'],
                ['å¤§æ•°æ®', 'æŠ€æœ¯å²—'],
                ['ç‰©è”ç½‘', 'æŠ€æœ¯å²—'],
                ['äº‘è®¡ç®—', 'æŠ€æœ¯å²—'],
                ['å‰ç«¯å¼€å‘', 'æŠ€æœ¯å²—']
            ];
            
            let successCount = 0;
            testCases.forEach(([techField, position], index) => {
                setTimeout(async () => {
                    console.log(`ğŸ”„ æµ‹è¯•APIåŠ è½½: ${techField} - ${position}`);
                    
                    try {
                        const response = await fetch(`/api/v1/questions/${encodeURIComponent(techField)}/${encodeURIComponent(position)}`);
                        const data = await response.json();
                        
                        if (data.status === 'success' && data.questions) {
                            console.log(`âœ… ${techField}-${position}: ${data.questions.length}ä¸ªé—®é¢˜`);
                            successCount++;
                        } else {
                            console.log(`âŒ ${techField}-${position}: ${data.message || 'åŠ è½½å¤±è´¥'}`);
                        }
                    } catch (error) {
                        console.log(`âŒ ${techField}-${position}: è¯·æ±‚å¤±è´¥`);
                    }
                    
                    // æœ€åä¸€ä¸ªæµ‹è¯•å®Œæˆåæ˜¾ç¤ºæ€»ç»“
                    if (index === testCases.length - 1) {
                        setTimeout(() => {
                            console.log(`ğŸ¯ APIæ•°æ®å®Œæ•´æ€§æµ‹è¯•å®Œæˆ: ${successCount}/${testCases.length} æˆåŠŸ`);
                        }, 100);
                    }
                }, index * 500); // é”™å¼€æ‰§è¡Œæ—¶é—´ï¼Œé¿å…APIå‹åŠ›
            });
        });
    } else {
        console.log('âŒ questionManageræœªæ‰¾åˆ°');
    }
};

window.testUnifiedSettings = function() {
    console.log('ğŸ§ª æµ‹è¯•ç»Ÿä¸€è®¾ç½®é¢æ¿...');
    showSettingsDialog();
};

window.testVoiceAnalysis = function() {
    console.log('ğŸ§ª æµ‹è¯•è¯­éŸ³åˆ†æ...');
    startVoiceAnalysis().then(success => {
        if (success) {
            console.log('âœ… è¯­éŸ³åˆ†æå¯åŠ¨æˆåŠŸ');
            // ç­‰å¾…2ç§’åè·å–è¯­éŸ³æ•°æ®
            setTimeout(() => {
                getVoiceRealtimeData();
            }, 2000);
        } else {
            console.log('âŒ è¯­éŸ³åˆ†æå¯åŠ¨å¤±è´¥');
        }
    });
};

window.testDataUpdate = function() {
    console.log('ğŸ§ª æµ‹è¯•æ•°æ®æ›´æ–°...');
    
    // æµ‹è¯•è¡¨æƒ…æ•°æ®æ›´æ–°
    const testExpressionData = {
        expression: {
            name: 'å¼€å¿ƒ',
            confidence: 0.85
        },
        action_units: [
            { code: 'AU12', value: 0.8 }
        ]
    };
    updateExpressionData(testExpressionData);
    
    // æµ‹è¯•åŠ¨ä½œæ•°æ®æ›´æ–°
    const testMotionData = {
        body_action: {
            name: 'æ­£å',
            confidence: 0.92
        }
    };
    updateMotionData(testMotionData);
    
    // æµ‹è¯•è¯­éŸ³æ•°æ®æ›´æ–°
    const testVoiceData = {
        emotion_cn: 'è‡ªä¿¡',
        confidence: 0.88,
        text: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¯­éŸ³æ•°æ®'
    };
    updateVoiceData(testVoiceData);
    
    console.log('âœ… æµ‹è¯•æ•°æ®æ›´æ–°å®Œæˆ');
};

window.testSettings = function() {
    console.log('ğŸ§ª æµ‹è¯•è®¾ç½®é¢æ¿...');
    showSettingsDialog();
};

window.testQuestionDisplay = function() {
    console.log('ğŸ§ª æµ‹è¯•é—®é¢˜æ˜¾ç¤º...');
    
    const questionElement = document.getElementById('current-question');
    const metaElement = document.getElementById('question-meta');
    
    if (questionElement && metaElement) {
        // æ˜¾ç¤ºæµ‹è¯•é—®é¢˜
        questionElement.innerHTML = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é—®é¢˜ï¼Œç”¨äºéªŒè¯é—®é¢˜æ˜¾ç¤ºåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚å¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™æ®µæ–‡å­—ï¼Œè¯´æ˜é—®é¢˜æ˜¾ç¤ºåŠŸèƒ½æ­£å¸¸ã€‚';
        metaElement.textContent = 'æµ‹è¯•æ¨¡å¼ - é—®é¢˜æ˜¾ç¤ºéªŒè¯';
        
        console.log('âœ… é—®é¢˜æ˜¾ç¤ºæµ‹è¯•å®Œæˆ');
    } else {
        console.error('âŒ é—®é¢˜æ˜¾ç¤ºå…ƒç´ æœªæ‰¾åˆ°');
        console.log('questionElement:', questionElement);
        console.log('metaElement:', metaElement);
    }
};

window.testDefaultRendering = function() {
    console.log('ğŸ§ª æµ‹è¯•é»˜è®¤æ¸²æŸ“çŠ¶æ€...');
    
    // æ£€æŸ¥è¡¨æƒ…æ£€æµ‹å¡ç‰‡
    const expressionCard = expressionCard || getDOMElements().expressionCard;
    const motionCard = motionCard || getDOMElements().motionCard;
    const voiceCard = voiceCard || getDOMElements().voiceCard;
    
    console.log('è¡¨æƒ…æ£€æµ‹å¡ç‰‡æ˜¾ç¤ºçŠ¶æ€:', expressionCard ? expressionCard.style.display || 'block' : 'æœªæ‰¾åˆ°');
    console.log('åŠ¨ä½œæ£€æµ‹å¡ç‰‡æ˜¾ç¤ºçŠ¶æ€:', motionCard ? motionCard.style.display || 'block' : 'æœªæ‰¾åˆ°');
    console.log('è¯­éŸ³æƒ…æ„Ÿåˆ†æå¡ç‰‡æ˜¾ç¤ºçŠ¶æ€:', voiceCard ? voiceCard.style.display || 'block' : 'æœªæ‰¾åˆ°');
    
    // ç¡®ä¿æ‰€æœ‰æ£€æµ‹åŠŸèƒ½éƒ½é»˜è®¤æ˜¾ç¤º
    if (expressionCard) {
        expressionCard.style.display = 'block';
        console.log('âœ… è¡¨æƒ…æ£€æµ‹å¡ç‰‡å·²ç¡®ä¿æ˜¾ç¤º');
    }
    
    if (motionCard) {
        motionCard.style.display = 'block';
        console.log('âœ… åŠ¨ä½œæ£€æµ‹å¡ç‰‡å·²ç¡®ä¿æ˜¾ç¤º');
    }
    
    if (voiceCard) {
        voiceCard.style.display = 'block';
        console.log('âœ… è¯­éŸ³æƒ…æ„Ÿåˆ†æå¡ç‰‡å·²ç¡®ä¿æ˜¾ç¤º');
    }
    
    console.log('ğŸ¯ æ‰€æœ‰æ£€æµ‹åŠŸèƒ½é»˜è®¤æ¸²æŸ“çŠ¶æ€æ£€æŸ¥å®Œæˆ');
};

window.testQuestionRendering = function() {
    console.log('ğŸ§ª æµ‹è¯•é—®é¢˜æ¸²æŸ“...');
    
    if (window.questionManager) {
        // æµ‹è¯•fallbacké—®é¢˜
        window.questionManager.loadFallbackQuestions('äººå·¥æ™ºèƒ½', 'æŠ€æœ¯å²—');
        
        setTimeout(() => {
            const questionElement = document.getElementById('current-question');
            const metaElement = document.getElementById('question-meta');
            
            console.log('é—®é¢˜å…ƒç´ å†…å®¹:', questionElement ? questionElement.textContent : 'æœªæ‰¾åˆ°');
            console.log('å…ƒæ•°æ®å…ƒç´ å†…å®¹:', metaElement ? metaElement.textContent : 'æœªæ‰¾åˆ°');
            
            if (questionElement && questionElement.textContent.trim()) {
                console.log('âœ… é—®é¢˜æ¸²æŸ“æˆåŠŸ');
            } else {
                console.log('âŒ é—®é¢˜æ¸²æŸ“å¤±è´¥');
            }
        }, 500);
    } else {
        console.log('âŒ questionManageræœªæ‰¾åˆ°');
    }
};

window.testUrlParams = function() {
    console.log('ğŸ§ª æµ‹è¯•URLå‚æ•°å¤„ç†...');
    
    const urlParams = new URLSearchParams(window.location.search);
    console.log('å½“å‰URLå‚æ•°:', {
        tech_field: urlParams.get('tech_field'),
        position: urlParams.get('position'),
        question_id: urlParams.get('question_id')
    });
    
    if (window.questionManager) {
        console.log('QuestionManagerå½“å‰çŠ¶æ€:', {
            techField: window.questionManager.currentTechField,
            position: window.questionManager.currentPosition,
            questionId: window.questionManager.currentQuestionId,
            questionsLoaded: window.questionManager.currentQuestions ? window.questionManager.currentQuestions.length : 0
        });
        
        // æµ‹è¯•ä½¿ç”¨ç‰¹å®šå‚æ•°
        const testUrl = '?tech_field=äººå·¥æ™ºèƒ½&position=æŠ€æœ¯å²—&question_id=2';
        console.log('ğŸ”— æµ‹è¯•URL:', window.location.origin + window.location.pathname + testUrl);
        console.log('ğŸ’¡ åœ¨æµè§ˆå™¨åœ°å€æ ä¸­æ·»åŠ ä»¥ä¸Šå‚æ•°æ¥æµ‹è¯•URLå‚æ•°åŠŸèƒ½');
    } else {
        console.log('âŒ questionManageræœªæ‰¾åˆ°');
    }
};

// åœ¨æ§åˆ¶å°è¾“å‡ºè°ƒè¯•ä¿¡æ¯
console.log('ğŸ¯ è°ƒè¯•ä¿¡æ¯ï¼š');
console.log('- å¦‚æœè®¾ç½®æŒ‰é’®ä»ä¸å·¥ä½œï¼Œè¯·åœ¨æ§åˆ¶å°è¿è¡Œ: testSettings()');
console.log('- å¦‚æœæ¬¢è¿ä¿¡æ¯ä¸æ˜¾ç¤ºï¼Œè¯·åœ¨æ§åˆ¶å°è¿è¡Œ: testWelcome()');
console.log('- å¦‚æœé—®é¢˜ä¸æ˜¾ç¤ºï¼Œè¯·åœ¨æ§åˆ¶å°è¿è¡Œ: testLoadQuestions()');
console.log('- æµ‹è¯•æ˜¾ç¤ºé—®é¢˜: testDisplayQuestion()');
console.log('- å¼ºåˆ¶æ˜¾ç¤ºæµ‹è¯•é—®é¢˜: forceShowQuestion()');
console.log('- åŠ è½½æŒ‡å®šé—®é¢˜: loadSpecificQuestion("äººå·¥æ™ºèƒ½", "æŠ€æœ¯å²—", 2)');
console.log('- æµ‹è¯•APIåŠ è½½: testApiLoading()');
console.log('- æµ‹è¯•APIæ•°æ®å®Œæ•´æ€§: testApiDataIntegrity()');
console.log('- æµ‹è¯•ç»Ÿä¸€è®¾ç½®é¢æ¿: testUnifiedSettings()');
console.log('- æµ‹è¯•è¯­éŸ³åˆ†æ: testVoiceAnalysis()');
console.log('- æµ‹è¯•æ•°æ®æ›´æ–°: testDataUpdate()');
console.log('- æµ‹è¯•è®¾ç½®é¢æ¿: testSettings()');
console.log('- æµ‹è¯•é—®é¢˜æ˜¾ç¤º: testQuestionDisplay()');
console.log('- æµ‹è¯•é»˜è®¤æ¸²æŸ“: testDefaultRendering()');
console.log('- æµ‹è¯•é—®é¢˜æ¸²æŸ“: testQuestionRendering()');
console.log('- æµ‹è¯•URLå‚æ•°: testUrlParams()');
console.log('- æ£€æŸ¥æ˜¯å¦æœ‰JavaScripté”™è¯¯');
console.log('- ç¡®è®¤æŒ‰é’®å…ƒç´ å­˜åœ¨');

// é¡µé¢åŠ è½½å®Œæˆåçš„ç»Ÿä¸€åˆå§‹åŒ–å·²åœ¨ä¸Šé¢çš„DOMContentLoadedä¸­å®Œæˆ
</script>

</body>
</html>
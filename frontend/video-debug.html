<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘è°ƒè¯•æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <style>
        .debug-info {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .video-container {
            border: 2px solid #3b82f6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .canvas-container {
            border: 2px solid #ef4444;
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">ğŸ¥ è§†é¢‘æ•è·è°ƒè¯•å·¥å…·</h1>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">æ§åˆ¶é¢æ¿</h2>
            <div class="flex space-x-4">
                <button id="startCamera" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition">
                    å¯åŠ¨æ‘„åƒå¤´
                </button>
                <button id="stopCamera" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition">
                    åœæ­¢æ‘„åƒå¤´
                </button>
                <button id="testCapture" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition" disabled>
                    æµ‹è¯•æ•è·
                </button>
                <button id="clearLog" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition">
                    æ¸…ç†æ—¥å¿—
                </button>
            </div>
        </div>
        
        <!-- è§†é¢‘å’ŒCanvasæ˜¾ç¤º -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- è§†é¢‘æ˜¾ç¤º -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ“¹ åŸå§‹è§†é¢‘æµ</h3>
                <div class="video-container">
                    <video id="testVideo" class="w-full h-64 bg-gray-800" autoplay muted playsinline></video>
                </div>
                <div id="videoStatus" class="mt-4 p-4 bg-gray-50 rounded text-sm">
                    <strong>è§†é¢‘çŠ¶æ€ï¼š</strong>ç­‰å¾…å¯åŠ¨æ‘„åƒå¤´...
                </div>
            </div>
            
            <!-- Canvasæ˜¾ç¤º -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ–¼ï¸ Canvasæ•è·</h3>
                <div class="canvas-container">
                    <canvas id="testCanvas" class="w-full h-64 bg-gray-200"></canvas>
                </div>
                <div id="canvasStatus" class="mt-4 p-4 bg-gray-50 rounded text-sm">
                    <strong>CanvasçŠ¶æ€ï¼š</strong>ç­‰å¾…æ•è·...
                </div>
            </div>
        </div>
        
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">ğŸ› è°ƒè¯•æ—¥å¿—</h3>
            <div id="debugLog" class="debug-info">
                <p class="text-gray-500">ç­‰å¾…æ“ä½œ...</p>
            </div>
        </div>
    </div>

    <script>
        let mediaStream = null;
        let video = null;
        let canvas = null;
        let context = null;
        let debugLog = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-blue-600',
                'success': 'text-green-600',
                'warning': 'text-yellow-600',
                'error': 'text-red-600'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `mb-1 ${colors[type] || colors['info']}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateVideoStatus() {
            const status = document.getElementById('videoStatus');
            if (!video) {
                status.innerHTML = '<strong>è§†é¢‘çŠ¶æ€ï¼š</strong>è§†é¢‘å…ƒç´ æœªåˆå§‹åŒ–';
                return;
            }
            
            status.innerHTML = `
                <strong>è§†é¢‘çŠ¶æ€ï¼š</strong><br>
                å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}<br>
                ReadyState: ${video.readyState}<br>
                CurrentTime: ${video.currentTime.toFixed(2)}s<br>
                Paused: ${video.paused}<br>
                Muted: ${video.muted}<br>
                SrcObject: ${!!video.srcObject}<br>
                è§†é¢‘è½¨é“: ${video.srcObject ? video.srcObject.getVideoTracks().length : 0}
            `;
        }
        
        function updateCanvasStatus() {
            const status = document.getElementById('canvasStatus');
            if (!canvas) {
                status.innerHTML = '<strong>CanvasçŠ¶æ€ï¼š</strong>Canvasæœªåˆå§‹åŒ–';
                return;
            }
            
            status.innerHTML = `
                <strong>CanvasçŠ¶æ€ï¼š</strong><br>
                å°ºå¯¸: ${canvas.width}x${canvas.height}<br>
                Context: ${!!context ? 'OK' : 'Error'}
            `;
        }
        
        async function startCamera() {
            try {
                log('ğŸš€ å¯åŠ¨æ‘„åƒå¤´...', 'info');
                
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: false
                };
                
                log(`ğŸ“‹ ä½¿ç”¨çº¦æŸ: ${JSON.stringify(constraints)}`, 'info');
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                log('âœ… æ‘„åƒå¤´è®¿é—®æˆåŠŸ', 'success');
                
                video.srcObject = mediaStream;
                
                // ç­‰å¾…è§†é¢‘å…ƒæ•°æ®åŠ è½½
                video.addEventListener('loadedmetadata', () => {
                    log(`ğŸ“º è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½: ${video.videoWidth}x${video.videoHeight}`, 'success');
                    updateVideoStatus();
                    document.getElementById('testCapture').disabled = false;
                });
                
                video.addEventListener('canplay', () => {
                    log('â–¶ï¸ è§†é¢‘å¯ä»¥æ’­æ”¾', 'success');
                    updateVideoStatus();
                });
                
                // å®šæœŸæ›´æ–°çŠ¶æ€
                setInterval(updateVideoStatus, 1000);
                
            } catch (error) {
                log(`âŒ å¯åŠ¨æ‘„åƒå¤´å¤±è´¥: ${error.message}`, 'error');
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
            }
        }
        
        async function stopCamera() {
            try {
                log('â¹ï¸ åœæ­¢æ‘„åƒå¤´...', 'info');
                
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                    log('âœ… æ‘„åƒå¤´å·²åœæ­¢', 'success');
                }
                
                video.srcObject = null;
                document.getElementById('testCapture').disabled = true;
                updateVideoStatus();
                
            } catch (error) {
                log(`âŒ åœæ­¢æ‘„åƒå¤´å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testCapture() {
            try {
                log('ğŸ“¸ å¼€å§‹æµ‹è¯•æ•è·...', 'info');
                
                if (!video.srcObject) {
                    log('âŒ è§†é¢‘æµä¸å­˜åœ¨', 'error');
                    return;
                }
                
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    log('âŒ è§†é¢‘å°ºå¯¸æ— æ•ˆ', 'error');
                    return;
                }
                
                // è®¾ç½®Canvaså°ºå¯¸
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                log(`ğŸ–¼ï¸ Canvaså°ºå¯¸è®¾ç½®ä¸º: ${canvas.width}x${canvas.height}`, 'info');
                
                // å…ˆå¡«å……çº¢è‰²èƒŒæ™¯
                context.fillStyle = '#FF0000';
                context.fillRect(0, 0, canvas.width, canvas.height);
                log('ğŸ”´ Canvaså·²å¡«å……çº¢è‰²èƒŒæ™¯', 'info');
                
                // ç»˜åˆ¶è§†é¢‘å¸§
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                log('âœ… è§†é¢‘å¸§å·²ç»˜åˆ¶åˆ°Canvas', 'success');
                
                // æ£€æŸ¥Canvaså†…å®¹
                const imageData = context.getImageData(0, 0, Math.min(canvas.width, 50), Math.min(canvas.height, 50));
                const data = imageData.data;
                let hasNonRedPixels = false;
                let redPixels = 0;
                let nonRedPixels = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] === 255 && data[i + 1] === 0 && data[i + 2] === 0) {
                        redPixels++;
                    } else {
                        hasNonRedPixels = true;
                        nonRedPixels++;
                    }
                }
                
                log(`ğŸ” åƒç´ åˆ†æ: çº¢è‰²=${redPixels}, éçº¢è‰²=${nonRedPixels}`, 'info');
                
                if (hasNonRedPixels) {
                    log('âœ… CanvasåŒ…å«è§†é¢‘å†…å®¹ï¼', 'success');
                } else {
                    log('âŒ Canvasåªæœ‰çº¢è‰²èƒŒæ™¯ï¼Œè§†é¢‘æœªæ­£ç¡®ç»˜åˆ¶', 'error');
                }
                
                // è½¬æ¢ä¸ºBlobå¹¶æ£€æŸ¥å¤§å°
                canvas.toBlob((blob) => {
                    if (blob) {
                        log(`ğŸ“¦ Blobåˆ›å»ºæˆåŠŸ: ${blob.size} bytes, ç±»å‹: ${blob.type}`, 'success');
                        
                        if (blob.size < 1000) {
                            log('âš ï¸ Blobå¤§å°å¼‚å¸¸å°ï¼Œå¯èƒ½æ˜¯ç©ºç™½å›¾åƒ', 'warning');
                        }
                        
                        // åˆ›å»ºä¸‹è½½é“¾æ¥ï¼ˆç”¨äºæ£€æŸ¥å›¾åƒï¼‰
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `test_capture_${Date.now()}.jpg`;
                        link.textContent = 'ä¸‹è½½æµ‹è¯•å›¾åƒ';
                        link.className = 'text-blue-600 underline ml-2';
                        
                        const downloads = document.getElementById('downloads') || (() => {
                            const div = document.createElement('div');
                            div.id = 'downloads';
                            div.className = 'mt-4 p-4 bg-blue-50 rounded';
                            div.innerHTML = '<strong>æµ‹è¯•å›¾åƒä¸‹è½½ï¼š</strong>';
                            document.querySelector('.max-w-6xl').appendChild(div);
                            return div;
                        })();
                        
                        downloads.appendChild(link);
                        
                    } else {
                        log('âŒ Blobåˆ›å»ºå¤±è´¥', 'error');
                    }
                }, 'image/jpeg', 0.8);
                
                updateCanvasStatus();
                
            } catch (error) {
                log(`âŒ æ•è·æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('æ•è·æµ‹è¯•å¤±è´¥:', error);
            }
        }
        
        function clearLog() {
            debugLog.innerHTML = '<p class="text-gray-500">æ—¥å¿—å·²æ¸…ç†...</p>';
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            video = document.getElementById('testVideo');
            canvas = document.getElementById('testCanvas');
            context = canvas.getContext('2d');
            debugLog = document.getElementById('debugLog');
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('startCamera').addEventListener('click', startCamera);
            document.getElementById('stopCamera').addEventListener('click', stopCamera);
            document.getElementById('testCapture').addEventListener('click', testCapture);
            document.getElementById('clearLog').addEventListener('click', clearLog);
            
            log('ğŸš€ è§†é¢‘è°ƒè¯•å·¥å…·å·²åˆå§‹åŒ–', 'success');
            updateVideoStatus();
            updateCanvasStatus();
        });
    </script>
</body>
</html>

# 实时语调分析功能测试指南

## 🎯 功能概述

本次更新实现了真正的实时语音语调分析功能，集成了现有的语音识别系统(`voice_recognition.py`)和音频分析工具(`multimodal_analyzer.py`)，在面试界面右侧实时显示语调分析结果和曲线图。

## ✨ 核心特性

### 🎼 **实时分析指标**
- **音高分析**: 实时检测语音基频变化 (80-400 Hz)
- **音量分析**: 实时检测音量强度 (-60 to 0 dB)  
- **语速分析**: 实时检测语音节奏 (0-200 BPM)

### 📊 **可视化界面**
- **实时曲线图**: 使用Chart.js绘制三个独立的实时更新曲线图
- **数值显示**: 显示当前音高、音量、语速的具体数值
- **状态指示器**: 正常/偏高/偏低的颜色编码状态显示
- **历史记录**: 保存最近60个数据点（约1分钟）

### 🔄 **系统集成**
- **WebSocket实时通信**: 通过现有语音识别WebSocket传输分析数据
- **自动启停**: 随语音录制自动启动和停止分析
- **无缝集成**: 与现有面试系统完全集成

## 🧪 测试流程

### 1. **启动系统**
```bash
cd SparkInterview
conda activate xinghuo
python main.py
```

### 2. **访问面试页面**
访问: `http://localhost:8000/frontend/interview.html`

### 3. **创建面试会话**
1. 点击"开始新面试"或选择现有会话
2. 确保摄像头和麦克风权限已授予
3. 查看右侧"实时语调分析"面板

### 4. **测试语调分析功能**

#### **步骤1: 启动录音**
- 点击麦克风按钮开始录音
- **预期结果**:
  - 右侧语调分析面板状态变为"正在分析..."
  - 三个图表容器准备就绪
  - 当前数值显示区域准备接收数据

#### **步骤2: 语音测试**
- 正常说话，变化语调和音量
- **预期结果**:
  - 📈 **音高图表**: 红色曲线实时反映语调变化
  - 📊 **音量图表**: 蓝色曲线实时反映音量变化  
  - 📉 **语速图表**: 黄色曲线实时反映语速变化
  - 数值实时更新显示当前指标
  - 状态指示器根据数值显示颜色状态

#### **步骤3: 变化测试**
进行以下语音变化测试：

**音高测试**:
- 低声说话 → 预期音高<100Hz，状态显示"偏低"  
- 正常说话 → 预期音高100-300Hz，状态显示"正常"
- 高声说话 → 预期音高>300Hz，状态显示"偏高"

**音量测试**:
- 轻声说话 → 预期音量<-40dB，状态显示"偏小"
- 正常说话 → 预期音量-40到-10dB，状态显示"正常"  
- 大声说话 → 预期音量>-10dB，状态显示"偏大"

**语速测试**:
- 慢速说话 → 预期语速<60BPM，状态显示"偏慢"
- 正常说话 → 预期语速60-150BPM，状态显示"正常"
- 快速说话 → 预期语速>150BPM，状态显示"偏快"

#### **步骤4: 停止录音**
- 点击麦克风按钮停止录音
- **预期结果**:
  - 语调分析状态变为"已停止"
  - 图表保持最后的数据显示
  - 分析历史数据被保存

### 5. **控制台调试检查**
打开浏览器开发者工具，检查控制台输出：

**预期日志内容**:
```
🎼 初始化语调分析集成
🎼 启动语调分析: voice_user_xxxxx_timestamp  
✅ 语调分析启动成功
📊 处理语调分析数据: {pitch: "150.5Hz", volume: "-25.2dB", speechRate: "120.3BPM"}
🎼 接收到语调分析数据: {timestamp: ..., pitch_mean: 150.5, ...}
🛑 停止语调分析
```

### 6. **后端日志检查** 
查看后端日志输出：

**预期日志内容**:
```
✅ Librosa音频分析库可用
🎼 实时音频分析: 音高=150.5Hz, 音量=-25.2dB, 语速=120.3
📊 发送语调分析结果: 音高=150.5Hz
```

## 🔧 故障排除

### **问题1: 图表不显示**
- **检查**: Chart.js库是否正确加载
- **解决**: 确保网络连接正常，CDN可访问

### **问题2: 无分析数据**
- **检查**: 后端是否安装了librosa
- **解决**: `pip install librosa` 

### **问题3: 图表显示异常**
- **检查**: 浏览器控制台是否有JavaScript错误
- **解决**: 刷新页面，检查语调分析器初始化

### **问题4: WebSocket连接失败**
- **检查**: 后端服务是否正常运行
- **解决**: 重启`python main.py`

## 📋 验收标准

### ✅ **核心功能**
- [x] 语音录制时自动启动语调分析
- [x] 实时显示音高、音量、语速三个指标
- [x] 三个独立图表正确绘制实时曲线
- [x] 数值和状态指示器实时更新
- [x] 录制结束时自动停止分析

### ✅ **数据准确性** 
- [x] 音高检测范围合理 (80-400 Hz)
- [x] 音量检测范围合理 (-60 to 0 dB)
- [x] 语速检测响应语音节奏变化
- [x] 状态指示器正确反映数值范围

### ✅ **用户体验**
- [x] 界面响应流畅，无明显延迟
- [x] 颜色编码直观易懂
- [x] 图表更新平滑
- [x] 与现有面试流程无缝集成

### ✅ **系统稳定性**
- [x] 长时间录制不影响性能
- [x] 异常情况下优雅降级
- [x] 内存使用控制在合理范围
- [x] WebSocket连接稳定

## 🚀 高级功能测试

### **API端点测试**
```bash
# 检查语调分析状态
curl http://localhost:8000/api/v1/voice/voice-analysis/status

# 获取会话分析历史
curl http://localhost:8000/api/v1/voice/voice-analysis/{session_id}/history
```

### **多会话测试**
- 测试多个用户同时使用语调分析
- 验证会话隔离正确性

### **性能测试**  
- 测试长时间连续录制（>5分钟）
- 验证内存使用和CPU占用

## 📊 预期结果示例

**正常运行时的典型数据**:
- 音高: 男声 85-180Hz，女声 165-265Hz
- 音量: 正常对话 -35 to -15dB  
- 语速: 中文普通话 100-160BPM

**界面效果**:
- 红色音高曲线波动反映语调变化
- 蓝色音量曲线反映说话强度
- 黄色语速曲线反映说话节奏
- 状态指示器动态显示正常/异常状态

测试完成后，这个功能将为面试官和应试者提供实时的语调反馈，帮助提升面试表现和分析质量。
